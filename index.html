<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doolin Coast Guard Call-out OPs</title>
<style>
  :root{
    --bg:#0b0b0b; --panel:#1c1c1c; --ink:#fff; --accent:#2aa3ff;
    --danger:#c40000; --danger2:#600; --muted:#888;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:Segoe UI,Arial,sans-serif}
  header{padding:12px 10px;background:#111;text-align:center;border-bottom:3px solid var(--accent)}
  h1{margin:0;font-size:1.9rem}
  /* SAR Incident */
  #sarIncident{background:rgba(220,0,0,0.85);color:#fff;padding:14px;margin:10px;border-radius:10px;text-align:center}
  #sarIncident h2{margin:0 0 8px}
  #incidentDetails{font-size:1.1rem;font-weight:600}
  /* Admin Panel */
  #adminPanel{display:none;background:var(--danger2);padding:12px;margin:10px;border-radius:10px}
  #adminPanel h3{margin:4px 0 8px}
  #adminPanel label{display:block;margin:6px 0}
  #adminPanel input{width:100%;max-width:700px}
  #adminPanel button{margin-top:8px}
  /* Info bar */
  #infoBar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#141414;
    padding:10px;border-top:1px solid #222;border-bottom:1px solid #222}
  #locName{font-weight:800}
  #latlon,#dataFrom,#clock{color:#ddd}
  #locationSelect{background:#0f0f0f;color:#fff;border:1px solid #333;padding:6px;border-radius:8px}
  /* Panels */
  main{display:flex;gap:16px;padding:12px;flex-wrap:wrap}
  .panel{flex:1 1 420px;background:var(--panel);border-radius:12px;padding:14px;min-height:160px}
  .panel h2{margin:0 0 10px;text-align:center}
  /* Debug console */
  #debug{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);color:#0f0;padding:6px 8px;font:12px/1.3 Consolas,monospace;max-height:140px;overflow:auto}
  #debug b{color:#0af}
  /* Footer */
  footer{padding:12px;text-align:center;background:#111;color:#ddd}
  #adminLink{display:inline-block;margin-top:6px;color:#4db3ff;cursor:pointer;text-decoration:underline}
  /* Mobile */
  @media (max-width:768px){
    h1{font-size:1.5rem}
    main{flex-direction:column}
  }
</style>
</head>
<body>
<header>
  <h1>Doolin Coast Guard Call-out OPs</h1>
</header>

<!-- SAR INCIDENT (always visible) -->
<section id="sarIncident">
  <h2>Latest Coast Guard Incident</h2>
  <div id="incidentDetails"><p>No active incident entered.</p></div>
</section>

<!-- ADMIN INPUT (visible when ?admin=1 or after clicking Admin link) -->
<div id="adminPanel">
  <h3>Admin Input â€” Coast Guard Incident</h3>
  <label>Incident # <input id="incNum" placeholder="e.g. 482" /></label>
  <label>Title <input id="incTitle" placeholder="e.g. Cliff rescue at Lahinch" /></label>
  <label>Summary (one sentence) <input id="incSummary" placeholder="e.g. One person injured after fall near Cliffs of Moher" /></label>
  <label>Location <input id="incLoc" placeholder="e.g. Lahinch, Co. Clare" /></label>
  <button onclick="saveIncident()">Save</button>
</div>

<!-- Sticky ops info -->
<div id="infoBar">
  <div>
    <span id="locName">Doolin Port</span>
    &nbsp;â€”&nbsp;<span id="latlon">Lat: 53.016, Lon: -9.400</span>
    &nbsp;â€”&nbsp;<span id="dataFrom">Data from: --:--:--</span>
  </div>
  <div>
    <label for="locationSelect">Location:</label>
    <select id="locationSelect"></select>
    &nbsp;&nbsp;<span id="clock">Current time: --:--:--</span>
  </div>
</div>

<main>
  <section class="panel">
    <h2>Weather</h2>
    <div id="weatherData">Loadingâ€¦</div>
  </section>

  <section class="panel">
    <h2>Tide Forecast</h2>
    <div id="tideData">Loadingâ€¦</div>
  </section>
</main>

<footer>
  <div id="latestData">Latest data as of: --</div>
  <div id="adminLink" onclick="goAdmin()">ðŸ”’ Admin</div>
</footer>

<pre id="debug"></pre>

<script>
/*** Compatibility helpers (older TV browsers) ***/
function log(msg){var d=document.getElementById('debug');d.innerHTML += msg + "\\n"; d.scrollTop = d.scrollHeight;}
function qs(id){return document.getElementById(id);}

function httpGetJson(url, onOk, onErr){
  // Use fetch if available, else XHR fallback
  try{
    if(window.fetch){
      fetch(url).then(function(r){
        if(!r.ok) throw new Error("HTTP "+r.status);
        return r.json();
      }).then(onOk).catch(function(e){ if(onErr) onErr(e); });
      return;
    }
  }catch(e){}
  var x=new XMLHttpRequest();
  x.open("GET", url, true);
  x.onreadystatechange=function(){
    if(x.readyState===4){
      if(x.status>=200 && x.status<300){
        try{ onOk(JSON.parse(x.responseText)); }
        catch(e){ if(onErr) onErr(e); }
      }else{
        if(onErr) onErr(new Error("HTTP "+x.status));
      }
    }
  };
  x.send();
}

/*** Incident panel (localStorage, no backend) ***/
function loadIncident(){
  try{
    var raw=localStorage.getItem("cgIncident");
    if(!raw){ return; }
    var data=JSON.parse(raw);
    if(data && data.title){
      qs("incidentDetails").innerHTML =
        "<strong>Incident #"+(data.num||"") + ":</strong> "+ (data.title||"") +
        "<br>"+ (data.summary||"") +
        "<br><em>Location: "+ (data.loc||"") +"</em>";
    }
  }catch(e){ log("Incident load error: "+e); }
}
function saveIncident(){
  try{
    var data={
      num:qs("incNum").value||"",
      title:qs("incTitle").value||"",
      summary:qs("incSummary").value||"",
      loc:qs("incLoc").value||""
    };
    localStorage.setItem("cgIncident", JSON.stringify(data));
    loadIncident();
    alert("Incident saved on this device.");
  }catch(e){ alert("Could not save: "+e); }
}
function goAdmin(){
  // Toggle admin=1 param
  var has = window.location.search.indexOf("admin=1")>-1;
  if(has){ window.location.search=""; }
  else{
    var q = window.location.search;
    if(q && q.length>1){ window.location.search = q + "&admin=1"; }
    else{ window.location.search = "?admin=1"; }
  }
}
(function(){
  if(window.location.search.indexOf("admin=1")>-1){
    qs("adminPanel").style.display="block";
  }
})();

/*** Location list + mapping to tide stations ***/
var LOCS = {
 "DOOLIN":{name:"Doolin Port",lat:53.016,lon:-9.4,station:"Inishmore"},
 "FANORE":{name:"Fanore",lat:53.140,lon:-9.280,station:"Inishmore"},
 "LAHINCH":{name:"Lahinch",lat:52.933,lon:-9.350,station:"Galway_Port"},
 "SPANISH_POINT":{name:"Spanish Point",lat:52.850,lon:-9.420,station:"Kilrush"},
 "KINVARA":{name:"Kinvara",lat:53.140,lon:-8.930,station:"Galway_Port"},
 "GALWAY":{name:"Galway",lat:53.270,lon:-9.050,station:"Galway_Port"},
 "TRALEE":{name:"Tralee",lat:52.270,lon:-9.700,station:"Fenit"},
 "DINGLE":{name:"Dingle",lat:52.140,lon:-10.270,station:"Dingle_Harbour"},
 "FANORE2":{name:"Fanore (alt)",lat:53.140,lon:-9.280,station:"Inishmore"},
 "QUILTY":{name:"Quilty",lat:52.820,lon:-9.450,station:"Kilrush"},
 "WHITESTRAND":{name:"Whitestrand",lat:52.850,lon:-9.420,station:"Kilrush"},
 "KILRUSH":{name:"Kilrush",lat:52.640,lon:-9.480,station:"Kilrush"},
 "KILKEE":{name:"Kilkee",lat:52.678,lon:-9.644,station:"Kilrush"},
 "INIS_MOR":{name:"Inis MÃ³r",lat:53.110,lon:-9.650,station:"Inishmore"},
 "INIS_MEAIN":{name:"Inis MeÃ¡in",lat:53.080,lon:-9.570,station:"Inishmaan"},
 "INIS_OIRR":{name:"Inis OÃ­rr",lat:53.060,lon:-9.510,station:"Inisheer"}
};
var DEFAULT_LOC = "DOOLIN";
var sel = qs("locationSelect");
function populateLocations(){
  // from URL: ?loc=KILKEE
  var urlLoc = (function(){
    var m = /[?&]loc=([^&]+)/.exec(window.location.search);
    return m ? decodeURIComponent(m[1]).toUpperCase() : null;
  })();
  var first = true;
  for(var k in LOCS){
    if(!LOCS.hasOwnProperty(k)) continue;
    var o = document.createElement("option");
    o.value = k;
    o.textContent = LOCS[k].name;
    sel.appendChild(o);
    if(first) first=false;
  }
  var init = LOCS[urlLoc] ? urlLoc : DEFAULT_LOC;
  sel.value = init;
  setCurrent(init);
}
function setCurrent(key){
  window.CUR = LOCS[key] || LOCS[DEFAULT_LOC];
  qs("locName").textContent = window.CUR.name;
  qs("latlon").textContent = "Lat: " + window.CUR.lat.toFixed(3) + ", Lon: " + window.CUR.lon.toFixed(3);
  // reflect in URL (shareable)
  try{
    var u = new URL(window.location.href);
    u.searchParams.set("loc", key);
    history.replaceState(null, "", u.toString());
  }catch(e){}
}

/*** Live clock ***/
function startClock(){
  function tick(){
    var now = new Date();
    qs("clock").textContent = "Current time: " + now.toLocaleTimeString("en-IE",{hour12:false});
  }
  tick();
  setInterval(tick, 1000);
}

/*** Weather (Open-Meteo) ***/
function compassDir(deg){
  var dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];
  return dirs[Math.round(deg/22.5)%16];
}
function loadWeather(cb){
  var u = "https://api.open-meteo.com/v1/forecast?latitude="+window.CUR.lat+"&longitude="+window.CUR.lon+"&current_weather=true&timezone=Europe%2FDublin";
  log("Weather â†’ "+u);
  httpGetJson(u, function(j){
    try{
      var cw = j && j.current_weather ? j.current_weather : null;
      if(!cw){ qs("weatherData").textContent="No weather data"; if(cb) cb(); return; }
      var html = ""
       + "<b>Temp:</b> " + cw.temperature + "Â°C"
       + " &nbsp; <b>Wind:</b> " + cw.windspeed + " km/h"
       + " (" + Math.round(cw.winddirection) + "Â° " + compassDir(cw.winddirection) + ")"
       + " &nbsp; <b>At:</b> " + cw.time;
      qs("weatherData").innerHTML = html;
    }catch(e){ qs("weatherData").textContent="Weather parse error"; log("Weather parse error: "+e); }
    if(cb) cb();
  }, function(e){
    qs("weatherData").textContent="Weather error";
    log("Weather error: "+e);
    if(cb) cb();
  });
}

/*** Tide forecast (Marine Institute ERDDAP TidePrediction) ***/
function isoNoMs(d){ return d.toISOString().split('.')[0] + "Z"; }
function loadTide(cb){
  var start = new Date();
  var end = new Date(start.getTime() + 6*3600*1000); // next 6h
  var url = "https://erddap.marine.ie/erddap/tabledap/TidePrediction.json?station_id,sea_surface_height,time"
          + "&station_id=" + encodeURIComponent(window.CUR.station)
          + "&time>=" + isoNoMs(start)
          + "&time<=" + isoNoMs(end);
  log("Tides â†’ "+url);
  httpGetJson(url, function(j){
    try{
      var table = j && j.table ? j.table : null;
      var rows = table && table.rows ? table.rows : [];
      if(!rows.length){ qs("tideData").textContent="No tide data"; if(cb) cb(); return; }
      // Render compact list
      var out = [];
      for(var i=0;i<rows.length;i++){
        var r = rows[i]; // [station_id, height, time]
        var t = new Date(r[2]).toLocaleTimeString("en-IE",{hour:'2-digit',minute:'2-digit',hour12:false});
        var h = parseFloat(r[1]);
        out.push(t + " â€” " + h.toFixed(2) + " m");
      }
      qs("tideData").innerHTML = out.join(" &nbsp;|&nbsp; ");
    }catch(e){ qs("tideData").textContent="Tide parse error"; log("Tide parse error: "+e); }
    if(cb) cb();
  }, function(e){
    qs("tideData").textContent="Tide error";
    log("Tide error: "+e);
    if(cb) cb();
  });
}

/*** Orchestrate refresh ***/
function refreshAll(){
  var now = new Date();
  qs("dataFrom").textContent = "Data from: " + now.toLocaleTimeString("en-IE",{hour12:false});
  qs("latestData").textContent = "Latest data as of: " + now.toLocaleTimeString("en-IE",{hour12:false});
  loadWeather(function(){ loadTide(function(){ /* done */ }); });
}

/*** Init ***/
(function init(){
  try{
    populateLocations();
    startClock();
    refreshAll();
    // Change handler
    sel.onchange = function(){
      setCurrent(sel.value);
      refreshAll();
    };
    // Auto-refresh every minute
    setInterval(refreshAll, 60000);
    // Load SAR incident (local)
    loadIncident();
  }catch(e){
    log("Init error: "+e);
  }
})();
</script>
</body>
</html>
