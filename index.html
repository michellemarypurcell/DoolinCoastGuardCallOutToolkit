<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Doolin Coast Guard SAR Call Out Toolkit</title>
<style>
body {
font-family: Arial, sans-serif;
background: url('background.jpg') no-repeat center center fixed;
background-size: cover;
color: #fff;
text-align: center;
margin: 0;
padding: 0;
}

h1 {
background: rgba(0, 0, 0, 0.6);
padding: 20px;
font-size: 3em;
}

.container {
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
gap: 40px;
margin: 20px auto;
max-width: 1200px;
}

.widget {
background: rgba(0, 0, 0, 0.65);
padding: 30px;
border-radius: 15px;
width: 90%;
max-width: 800px;
font-size: 1.8em;
text-align: left;
}

.widget h2 {
margin-top: 0;
font-size: 2em;
text-align: center;
}

input, button {
font-size: 1.5em;
padding: 10px;
margin: 10px;
}
</style>
</head>
<body>
<h1>Doolin Coast Guard SAR Call Out Toolkit</h1>

<div>
<input type="text" id="location" placeholder="Enter Irish location (e.g. Doolin)">
<button onclick="updateData()">Update</button>
</div>

<div class="container">
<div class="widget">
<h2>Weather</h2>
<div id="weatherData">Loading...</div>
</div>

<div class="widget">
<h2>Tides</h2>
<div id="tideData">Loading...</div>
</div>

<div class="widget">
<h2>SAR News</h2>
<div id="newsData">Loading...</div>
</div>
</div>

<script>
// ðŸ‘‡ replace this with your actual Cloudflare Worker URL once deployed
const proxy = "https://YOUR-WORKER-NAME.YOURNAME.workers.dev/?url=";

// Weather stations (subset â€” expand later with full list)
const weatherStations = [
{ id: "SHANNON_AIRPORT", lat: 52.7, lon: -8.9 },
{ id: "GALWAY_AIRPORT", lat: 53.3, lon: -8.9 },
{ id: "VALENTIA_OBSERVATORY", lat: 51.93, lon: -10.25 }
];

// Tide stations
const tideStations = [
{ id: "GALWAY_PORT", lat: 53.27, lon: -9.05 },
{ id: "KILRUSH", lat: 52.63, lon: -9.5 },
{ id: "FENIT", lat: 52.27, lon: -9.87 },
{ id: "VALENTIA", lat: 51.93, lon: -10.25 }
];

function haversine(lat1, lon1, lat2, lon2) {
const R = 6371;
const dLat = (lat2-lat1) * Math.PI/180;
const dLon = (lon2-lon1) * Math.PI/180;
const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function nearestStation(lat, lon, stations) {
return stations.reduce((prev, cur) => {
return (haversine(lat, lon, cur.lat, cur.lon) < haversine(lat, lon, prev.lat, prev.lon)) ? cur : prev;
});
}

async function updateData() {
const query = document.getElementById("location").value || "Doolin";

// Geocode via OpenStreetMap Nominatim
const geoUrl = proxy + encodeURIComponent(`https://nominatim.openstreetmap.org/search?format=json&q=${query},Ireland`);
const geoResp = await fetch(geoUrl);
const geoData = await geoResp.json();
if (!geoData.length) {
document.getElementById("weatherData").textContent = "Location not found.";
document.getElementById("tideData").textContent = "";
return;
}
const lat = parseFloat(geoData[0].lat);
const lon = parseFloat(geoData[0].lon);

// Find nearest stations
const nearestWeather = nearestStation(lat, lon, weatherStations);
const nearestTide = nearestStation(lat, lon, tideStations);

// WEATHER
try {
const weatherUrl = proxy + encodeURIComponent(`https://prodapi.metweb.ie/observations/${nearestWeather.id}`);
const w = await fetch(weatherUrl);
const weather = await w.json();
document.getElementById("weatherData").innerHTML = `
<strong>${nearestWeather.id}</strong><br>
Temp: ${weather.report.temperature} Â°C<br>
Wind: ${weather.report.wind_speed} kt (${weather.report.wind_direction_text})<br>
Gusts: ${weather.report.wind_gust} kt<br>
Pressure: ${weather.report.pressure} hPa
`;
} catch (e) {
document.getElementById("weatherData").textContent = "Error fetching weather.";
}

// TIDES (next 12h only)
try {
const tideUrl = proxy + encodeURIComponent(
`https://erddap.marine.ie/erddap/tabledap/I_NATIONAL_TIDE_GAUGE_NETWORK.json?station_id,sea_surface_height,time&station_id="${nearestTide.id}"&time>=now&time<=now+12hours`
);
const t = await fetch(tideUrl);
const tides = await t.json();
const rows = tides.table.rows.map(r => {
const [id, height, time] = r;
return `<li>${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} â€” ${height.toFixed(2)} m</li>`;
}).join("");
document.getElementById("tideData").innerHTML = `<strong>${nearestTide.id}</strong><br><ul style="list-style:none; padding:0">${rows}</ul>`;
} catch (e) {
document.getElementById("tideData").textContent = "Error fetching tides.";
}

// SAR NEWS (simple RSS search)
try {
const newsUrl = proxy + encodeURIComponent("https://news.google.com/rss/search?q=Irish+Coast+Guard+SAR&hl=en-IE&gl=IE&ceid=IE:en");
const n = await fetch(newsUrl);
const text = await n.text();
const parser = new DOMParser();
const xml = parser.parseFromString(text, "text/xml");
const items = xml.querySelectorAll("item");
let html = "<ul style='list-style:none; padding:0'>";
items.forEach((item, idx) => {
if (idx < 5) {
html += `<li><a href="${item.querySelector("link").textContent}" target="_blank" style="color:#fff">${item.querySelector("title").textContent}</a></li>`;
}
});
html += "</ul>";
document.getElementById("newsData").innerHTML = html;
} catch (e) {
document.getElementById("newsData").textContent = "Error fetching news.";
}
}

// Auto-refresh every 60s
setInterval(updateData, 60000);
window.onload = updateData;
</script>
</body>
</html>
