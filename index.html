<script>
// Map locations to coordinates + tide stations
const stationLookup = {
"DOOLIN": { lat: 53.016, lon: -9.4, tide: "GALWAY_PORT" },
"KILKEE": { lat: 52.678, lon: -9.644, tide: "KILRUSH" },
"LAHINCH": { lat: 52.933, lon: -9.35, tide: "GALWAY_PORT" },
"SPANISH_POINT": { lat: 52.85, lon: -9.42, tide: "KILRUSH" },
"KINVARA": { lat: 53.14, lon: -8.93, tide: "GALWAY_PORT" },
"GALWAY": { lat: 53.27, lon: -9.05, tide: "GALWAY_PORT" },
"TRALEE": { lat: 52.27, lon: -9.7, tide: "FENIT" },
"DINGLE": { lat: 52.14, lon: -10.27, tide: "VALENTIA" }
};

async function updateData() {
const loc = document.getElementById("location").value;
const station = stationLookup[loc];
const debugDiv = document.getElementById("debug");
debugDiv.innerHTML = "";

document.getElementById("subtitle").textContent = `Data for ${loc}`;
const now = new Date();
document.getElementById("lastUpdated").textContent =
`Last updated: ${now.toLocaleString()}`;

// WEATHER (Open-Meteo)
try {
const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${station.lat}&longitude=${station.lon}&current_weather=true`;
debugDiv.innerHTML += `<div>Fetching weather: ${weatherUrl}</div>`;
const w = await fetch(weatherUrl);
const weather = await w.json();
const c = weather.current_weather;
document.getElementById("weatherData").innerHTML = `
<strong>${loc}</strong><br>
Temp: ${c.temperature} °C<br>
Wind: ${c.windspeed} km/h (dir ${c.winddirection}°)<br>
Time: ${c.time}
`;
} catch (e) {
document.getElementById("weatherData").textContent = "Error fetching weather.";
debugDiv.innerHTML += `<div style="color:red">Weather error: ${e}</div>`;
}

// TIDES (Marine Institute ERDDAP)
try {
const start = new Date();
const end = new Date(start.getTime() + 12 * 3600 * 1000);
const startISO = start.toISOString();
const endISO = end.toISOString();
const tideUrl =
`https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?station_id,sea_surface_height,time&station_id=${station.tide}&time>=${startISO}&time<=${endISO}`;
debugDiv.innerHTML += `<div>Fetching tides: ${tideUrl}</div>`;
const t = await fetch(tideUrl);
const tides = await t.json();
if (tides.table.rows.length === 0) throw "No tide data available";
const rows = tides.table.rows.map(r => {
const [id, height, time] = r;
return `<li>${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} — ${height.toFixed(2)} m</li>`;
}).join("");
document.getElementById("tideData").innerHTML =
`<strong>${station.tide}</strong><br><ul style="list-style:none; padding:0">${rows}</ul>`;
} catch (e) {
document.getElementById("tideData").textContent = "Error fetching tides.";
debugDiv.innerHTML += `<div style="color:red">Tide error: ${e}</div>`;
}

// SAR NEWS (Google + RNLI fallback)
try {
const newsUrl = `https://news.google.com/rss/search?q=Irish+Coast+Guard+SAR&hl=en-IE&gl=IE&ceid=IE:en`;
debugDiv.innerHTML += `<div>Fetching news: ${newsUrl}</div>`;
let n = await fetch(newsUrl);
let text = await n.text();
if (text.includes("<rss") === false) {
// fallback to RNLI
n = await fetch("https://rnli.org/news-and-media/rss-feeds/latest-news");
text = await n.text();
}
const parser = new DOMParser();
const xml = parser.parseFromString(text, "text/xml");
const items = xml.querySelectorAll("item");
let html = "<ul style='list-style:none; padding:0'>";
items.forEach((item, idx) => {
if (idx < 5) {
html += `<li><a href="${item.querySelector("link").textContent}" target="_blank" style="color:#fff">${item.querySelector("title").textContent}</a></li>`;
}
});
html += "</ul>";
document.getElementById("newsData").innerHTML = html;
} catch (e) {
document.getElementById("newsData").textContent = "Error fetching news.";
debugDiv.innerHTML += `<div style="color:red">News error: ${e}</div>`;
}
}

// refresh every 60s
setInterval(updateData, 60000);
window.onload = updateData;
</script>
