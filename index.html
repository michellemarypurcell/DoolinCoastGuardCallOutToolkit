<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doolin Irish Coast Guard Unit - Latest data for active call out</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            text-align: center;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            font-size: 2.5em;
            margin: 0;
        }
        #warnings {
            background: rgba(255, 165, 0, 0.8);
            padding: 10px;
            font-size: 1.5em;
            display: none;
            text-shadow: 1px 1px 2px black;
        }
        #locationBox {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.9em;
            z-index: 1000;
        }
        #locationBox label { font-weight: bold; margin-right: 5px; }
        #subtitle { font-size: 1.4em; margin: 10px 0; }
        #locationInfo {
            position: sticky;
            top: 0;
            z-index: 900;
            font-size: 1.2em;
            background: rgba(0,0,0,0.8);
            padding: 12px;
            border-bottom: 2px solid #0077cc;
        }
        #lastUpdated {
            background: #0077cc;
            color: white;
            padding: 5px;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        .container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: stretch;
            gap: 20px;
            margin: 20px auto;
            max-width: 1400px;
            flex-grow: 1;
        }
        .widget {
            background: rgba(0, 0, 0, 0.65);
            padding: 20px;
            border-radius: 15px;
            width: 45%;
            font-size: 1.6em; /* Slightly larger for TV */
            text-align: left;
        }
        .widget h2 { margin-top: 0; font-size: 2.2em; text-align: center; }
        .legend { font-size: 0.9em; margin-top: 10px; }
        .legend span {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 6px;
            border-radius: 4px;
        }
        #ticker {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 1.2em;
            white-space: nowrap;
            overflow: hidden;
        }
        #headline {
            animation: scroll 20s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        #debug {
            position: fixed;
            bottom: 60px;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            font-size: 0.8em;
            text-align: left;
            padding: 5px;
            max-height: 150px;
            overflow: auto;
            display: none; /* Hide by default; set to block to debug */
        }
        #footer {
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 1em;
        }
        ul { list-style: none; padding: 0; }
        li { margin: 5px 0; }
    </style>
</head>
<body>
    <h1>Doolin Irish Coast Guard Unit - Latest data for active call out</h1>
    <div id="warnings">No active warnings</div>
    <div id="locationBox">
        <label for="location">Change location:</label>
        <select id="location" onchange="updateData()">
            <option value="DOOLIN" selected>Doolin Port</option>
            <option value="KILKEE">Kilkee</option>
            <option value="LAHINCH">Lahinch</option>
            <option value="SPANISH_POINT">Spanish Point</option>
            <option value="KINVARA">Kinvara</option>
            <option value="GALWAY">Galway</option>
            <option value="TRALEE">Tralee</option>
            <option value="DINGLE">Dingle</option>
            <option value="FANORE">Fanore</option>
            <option value="QUILTY">Quilty</option>
            <option value="WHITESTRAND">Whitestrand</option>
            <option value="KILRUSH">Kilrush</option>
            <option value="INIS_MOR">Inis M√≥r</option>
            <option value="INIS_MEAIN">Inis Me√°in</option>
            <option value="INIS_OIRR">Inis O√≠rr</option>
        </select>
    </div>
    <div id="subtitle">Data for </div>
    <div id="locationInfo">Loading location info‚Ä¶</div>
    <div id="lastUpdated">Last updated: loading‚Ä¶</div>
    <div class="container">
        <div class="widget">
            <h2>Weather</h2>
            <div id="weatherData">Loading...</div>
        </div>
        <div class="widget">
            <h2>Tides</h2>
            <div id="tideData">Loading...</div>
            <div class="legend">
                <div><span style="background:red"></span> Low (&lt;0.5 m)</div>
                <div><span style="background:orange"></span> Caution (0.5‚Äì1.5 m)</div>
                <div><span style="background:limegreen"></span> Good (1.5‚Äì3.0 m)</div>
                <div><span style="background:deepskyblue"></span> Very High (&gt;3.0 m)</div>
            </div>
        </div>
    </div>
    <div id="ticker">
        <div id="headline">SAR News: Loading...</div>
    </div>
    <div id="footer">Latest data as of: loading...</div>
    <div id="debug"></div>

    <script>
        // Station lookup with ERDDAP station_id
        const stationLookup = {
            "DOOLIN": { lat: 53.016, lon: -9.4, tide: "Galway Port" },
            "KILKEE": { lat: 52.678, lon: -9.644, tide: "Kilrush Lough" },
            "LAHINCH": { lat: 52.933, lon: -9.35, tide: "Galway Port" },
            "SPANISH_POINT": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KINVARA": { lat: 53.14, lon: -8.93, tide: "Galway Port" },
            "GALWAY": { lat: 53.27, lon: -9.05, tide: "Galway Port" },
            "TRALEE": { lat: 52.27, lon: -9.7, tide: "Galway Port" },
            "DINGLE": { lat: 52.14, lon: -10.27, tide: "Dingle Harbour" },
            "FANORE": { lat: 53.14, lon: -9.28, tide: "Galway Port" },
            "QUILTY": { lat: 52.82, lon: -9.45, tide: "Kilrush Lough" },
            "WHITESTRAND": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KILRUSH": { lat: 52.64, lon: -9.48, tide: "Kilrush Lough" },
            "INIS_MOR": { lat: 53.11, lon: -9.65, tide: "Galway Port" },
            "INIS_MEAIN": { lat: 53.08, lon: -9.57, tide: "Galway Port" },
            "INIS_OIRR": { lat: 53.06, lon: -9.51, tide: "Galway Port" }
        };

        // Weather code to icon mapping (Open-Meteo WMO codes)
        const weatherIcons = {
            0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 48: "üå´Ô∏è",
            51: "üå¶Ô∏è", 53: "üå¶Ô∏è", 55: "üå¶Ô∏è", 61: "üåßÔ∏è", 63: "üåßÔ∏è", 65: "üåßÔ∏è",
            71: "‚ùÑÔ∏è", 73: "‚ùÑÔ∏è", 75: "‚ùÑÔ∏è", 80: "üå¶Ô∏è", 95: "‚õàÔ∏è", 99: "‚õàÔ∏è"
        };

        // Fallback SAR headlines from document
        const fallbackHeadlines = [
            "Coast Guard postpones rollout of new system at Sligo base - RTE.ie",
            "Irish Coast Guard Director Says He Has Full Confidence In New SAR Service - Afloat",
            "Minister Canny Announces Agreement on Irish Coast Guard Air Handover - The Fishing Daily",
            "Search and rescue operations by Coast Guard relocated to Weston - Echo.ie",
            "A change in the company managing the Coast Guard's rescue contract has been pushed back to 2026 - The Journal"
        ];

        let sarHeadlines = fallbackHeadlines;
        let currentHeadlineIndex = 0;

        // Rotate SAR headlines every 10s
        function rotateHeadline() {
            const headlineEl = document.getElementById('headline');
            headlineEl.textContent = sarHeadlines[currentHeadlineIndex];
            currentHeadlineIndex = (currentHeadlineIndex + 1) % sarHeadlines.length;
        }
        setInterval(rotateHeadline, 10000);

        // Update clock and location info (24h)
        function updateClock() {
            const now = new Date();
            const irishTime = now.toLocaleString("en-IE", {
                timeZone: "Europe/Dublin",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            });
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            document.getElementById("locationInfo").innerHTML =
                `<strong>${loc}</strong><br>Lat: ${s.lat.toFixed(3)}, Lon: ${s.lon.toFixed(3)}<br>Time: ${irishTime}`;
            document.getElementById("lastUpdated").textContent =
                `Last updated: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
            document.getElementById("footer").textContent =
                `Latest data as of: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
        }
        setInterval(updateClock, 1000);

        async function updateData() {
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            const debugDiv = document.getElementById("debug");
            debugDiv.innerHTML = "";
            document.getElementById("subtitle").textContent = `Data for ${loc}`;
            updateClock();

            // Met √âireann Warnings (via proxy to scrape https://www.met.ie/warnings)
            try {
                const warningsUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://www.met.ie/warnings");
                debugDiv.innerHTML += `<div>Fetching warnings: ${warningsUrl}</div>`;
                const w = await fetch(warningsUrl);
                if (!w.ok) throw new Error(w.statusText);
                const html = await w.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const warnings = [];
                // Parse for warning elements (inspect page: look for warning cards/divs)
                const warningEls = doc.querySelectorAll('.warning-item, .warning, [class*="warning"]'); // Adjust selectors based on page structure
                warningEls.forEach(el => {
                    const level = el.className.includes('yellow') ? 'Yellow' : el.className.includes('orange') ? 'Orange' : el.className.includes('red') ? 'Red' : null;
                    if (["Yellow", "Orange", "Red"].includes(level)) {
                        const headline = el.querySelector('h3, .title, .headline')?.textContent || el.textContent.trim();
                        warnings.push({ level, headline });
                    }
                });
                const warningsEl = document.getElementById("warnings");
                let warningText = "";
                warnings.forEach(wn => {
                    warningText += `${wn.level} WARNING: ${wn.headline}<br>`;
                    warningsEl.style.background = wn.level === "Red" ? "rgba(255,0,0,0.8)" :
                                                  wn.level === "Orange" ? "rgba(255,165,0,0.8)" : "rgba(255,255,0,0.8)";
                });
                if (warningText) {
                    warningsEl.innerHTML = warningText;
                    warningsEl.style.display = "block";
                } else {
                    warningsEl.style.display = "none";
                }
            } catch (e) {
                document.getElementById("warnings").style.display = "none";
                debugDiv.innerHTML += `<div style="color:red">Warnings error: ${e.message}</div>`;
            }

            // Weather (Open-Meteo - fixed URL)
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current_weather=true&hourly=temperature_2m,windspeed_10m,winddirection_10m,weathercode&timezone=Europe%2FDublin`;
                debugDiv.innerHTML += `<div>Fetching weather: ${weatherUrl}</div>`;
                const resp = await fetch(weatherUrl);
                if (!resp.ok) throw new Error(resp.statusText);
                const data = await resp.json();
                const c = data.current_weather;
                const h = data.hourly;
                const nowIdx = h.time.findIndex(t => new Date(t) >= new Date());
                const next3hIdx = nowIdx >= 0 ? nowIdx + 3 : 0; // Next 3h or fallback
                const nextTemp = h.temperature_2m[next3hIdx] || c.temperature;
                const nextWind = h.windspeed_10m[next3hIdx] || c.windspeed;
                const nextCode = h.weathercode[next3hIdx] || c.weathercode;
                document.getElementById("weatherData").innerHTML =
                    `<strong>${loc}</strong><br>
                    Current: ${c.temperature} ¬∞C ${weatherIcons[c.weathercode] || "üå§Ô∏è"}<br>
                    Wind: ${c.windspeed} km/h (dir ${c.winddirection.toFixed(0)}¬∞)<br>
                    Next 3h: ${nextTemp} ¬∞C ${weatherIcons[nextCode] || "üå§Ô∏è"}, Wind ${nextWind} km/h`;
            } catch (e) {
                document.getElementById("weatherData").textContent = "Error fetching weather";
                debugDiv.innerHTML += `<div style="color:red">Weather error: ${e.message}</div>`;
            }

            // Tides (Observed last 24h + Forecast next 24h; fix Date parsing)
            try {
                const now = new Date();
                const nowUnix = Math.floor(now.getTime() / 1000); // Unix seconds
                const startObsUnix = nowUnix - 24 * 3600;
                const endForecastUnix = nowUnix + 24 * 3600;
                const tideObsUrl = `https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?station_id="${encodeURIComponent(s.tide)}"&time>=${startObsUnix}&time<=${nowUnix}&sea_surface_height`;
                const tideForecastUrl = `https://erddap.marine.ie/erddap/tabledap/imi_tide_pred.json?station_id="${encodeURIComponent(s.tide)}"&time>=${nowUnix}&time<=${endForecastUnix}&sea_surface_height`;
                debugDiv.innerHTML += `<div>Fetching observed tides: ${tideObsUrl}</div>`;
                debugDiv.innerHTML += `<div>Fetching forecast tides: ${tideForecastUrl}</div>`;
                
                // Observed
                const tObs = await fetch(tideObsUrl);
                if (!tObs.ok) throw new Error(tObs.statusText);
                const obsData = await tObs.json();
                let allTides = obsData.table?.rows?.map(r => ({ 
                    time: new Date(r[2] * 1000), // Fix: Unix seconds to ms
                    height: r[1],
                    type: "Observed"
                })) || [];
                
                // Forecast
                const tForecast = await fetch(tideForecastUrl);
                if (!tForecast.ok) throw new Error(tForecast.statusText);
                const forecastData = await tForecast.json();
                allTides = allTides.concat(forecastData.table?.rows?.map(r => ({ 
                    time: new Date(r[2] * 1000), // Fix: Unix seconds to ms
                    height: r[1],
                    type: "Forecast"
                })) || []);
                
                allTides.sort((a, b) => a.time - b.time);
                if (allTides.length === 0) throw new Error("No tide data available");
                
                // Find next high/low (after now)
                let nextHigh = null, nextLow = null;
                for (let i = 0; i < allTides.length - 1; i++) {
                    if (allTides[i].time > now) {
                        if (allTides[i + 1].height > allTides[i].height && !nextHigh) nextHigh = allTides[i + 1];
                        if (allTides[i + 1].height < allTides[i].height && !nextLow) nextLow = allTides[i + 1];
                        if (nextHigh && nextLow) break;
                    }
                }
                
                // Render
                const rows = allTides.map((t, i, a) => {
                    const h = t.height;
                    let color = h < 0.5 ? "red" : h < 1.5 ? "orange" : h <= 3.0 ? "limegreen" : "deepskyblue";
                    let arrow = i < a.length - 1 ? (a[i + 1].height > h ? "‚¨Ü" : a[i + 1].height < h ? "‚¨á" : "") : "";
                    return `<li style="color:${color}">${t.type}: ${t.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${h.toFixed(2)} m ${arrow}</li>`;
                }).join("");
                
                document.getElementById("tideData").innerHTML =
                    `<strong>${s.tide}</strong><br>
                    ‚¨ÜÔ∏è Next High: ${nextHigh ? `${nextHigh.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${nextHigh.height.toFixed(2)} m` : "N/A"}<br>
                    ‚¨áÔ∏è Next Low: ${nextLow ? `${nextLow.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${nextLow.height.toFixed(2)} m` : "N/A"}<br>
                    <ul>${rows}</ul>`;
            } catch (e) {
                document.getElementById("tideData").innerHTML = `<strong>${s.tide}</strong><br>Error fetching tides: ${e.message}<br>(Check Marine Institute for updates)`;
                debugDiv.innerHTML += `<div style="color:red">Tides error: ${e.message}</div>`;
            }

            // SAR News
            try {
                const rss = "https://news.google.com/rss/search?q=Irish+Coast+Guard+SAR&hl=en-IE&gl=IE&ceid=IE:en";
                const newsUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`;
                debugDiv.innerHTML += `<div>Fetching news: ${newsUrl}</div>`;
                const n = await fetch(newsUrl);
                if (!n.ok) throw new Error(n.statusText);
                const j = await n.json();
                if (j.items?.length) {
                    sarHeadlines = j.items.slice(0, 6).map(it => `SAR News: ${it.title}`);
                } else {
                    throw new Error("No items");
                }
                rotateHeadline();
            } catch (e) {
                console.warn("News fallback:", e);
                sarHeadlines = fallbackHeadlines;
                rotateHeadline();
                debugDiv.innerHTML += `<div style="color:yellow">News fallback used</div>`;
            }
        }

        setInterval(updateData, 60000);
        window.onload = () => { updateData(); updateClock(); rotateHeadline(); };
    </script>
</body>
</html>
