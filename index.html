<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doolin Irish Coast Guard Unit - Active Call Out</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            font-size: 3em;
            margin: 0;
            text-align: center;
        }
        #warnings {
            background: rgba(255, 165, 0, 0.8);
            padding: 15px;
            font-size: 1.8em;
            display: none;
            text-shadow: 1px 1px 2px black;
        }
        #locationBox {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 1em;
            z-index: 1000;
            display: block; /* Hide on mobile */
        }
        #locationBox label { font-weight: bold; margin-right: 5px; }
        #locationInfo {
            position: sticky;
            top: 0;
            z-index: 900;
            font-size: 1.5em;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-bottom: 2px solid #0077cc;
        }
        #lastUpdated {
            background: #0077cc;
            color: white;
            padding: 10px;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
            align-content: start;
        }
        .widget {
            background: rgba(0, 0, 0, 0.65);
            padding: 20px;
            border-radius: 15px;
            font-size: 2.5em;
            text-align: center;
        }
        .widget h2 {
            margin-top: 0;
            font-size: 3em;
            text-align: center;
        }
        .legend { font-size: 1em; margin-top: 10px; }
        .legend span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
        }
        #ticker {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 1.5em;
            white-space: nowrap;
            overflow: hidden;
        }
        #headline {
            animation: scroll 20s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        #debug {
            position: fixed;
            bottom: 70px;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            font-size: 0.9em;
            text-align: left;
            padding: 5px;
            max-height: 150px;
            overflow: auto;
            display: none; /* Show with 'block' for debugging */
        }
        #footer {
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 1.2em;
        }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; }

        /* Mobile adjustments (<768px) */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-x: hidden;
            }
            h1 { font-size: 1.8em; padding: 10px; }
            #warnings { font-size: 1.2em; padding: 10px; }
            #locationBox { display: none; } /* Hide dropdown on mobile */
            #locationInfo { font-size: 1em; padding: 10px; }
            #lastUpdated { font-size: 1em; padding: 5px; }
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 10px;
            }
            .widget {
                width: 100%;
                font-size: 1.2em;
                padding: 10px;
            }
            .widget h2 { font-size: 1.8em; }
            #ticker { height: 40px; font-size: 1em; }
            #footer { font-size: 0.9em; padding: 5px; }
            .legend { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <h1>Doolin Irish Coast Guard Unit - Active Call Out</h1>
    <div id="warnings">No active warnings</div>
    <div id="locationBox">
        <label for="location">Change location:</label>
        <select id="location" onchange="updateData()">
            <option value="DOOLIN" selected>Doolin Port</option>
            <option value="KILKEE">Kilkee</option>
            <option value="LAHINCH">Lahinch</option>
            <option value="SPANISH_POINT">Spanish Point</option>
            <option value="KINVARA">Kinvara</option>
            <option value="GALWAY">Galway</option>
            <option value="TRALEE">Tralee</option>
            <option value="DINGLE">Dingle</option>
            <option value="FANORE">Fanore</option>
            <option value="QUILTY">Quilty</option>
            <option value="WHITESTRAND">Whitestrand</option>
            <option value="KILRUSH">Kilrush</option>
            <option value="INIS_MOR">Inis M√≥r</option>
            <option value="INIS_MEAIN">Inis Me√°in</option>
            <option value="INIS_OIRR">Inis O√≠rr</option>
        </select>
    </div>
    <div id="locationInfo">Loading location info‚Ä¶</div>
    <div id="lastUpdated">Latest data as of: loading‚Ä¶</div>
    <div class="container">
        <div class="widget">
            <h2>Weather</h2>
            <div id="weatherData">Loading...</div>
        </div>
        <div class="widget">
            <h2>Tides</h2>
            <div id="tideData">Loading...</div>
            <div class="legend">
                <div><span style="background:red"></span> Low (&lt;0.5 m)</div>
                <div><span style="background:orange"></span> Caution (0.5‚Äì1.5 m)</div>
                <div><span style="background:limegreen"></span> Good (1.5‚Äì3.0 m)</div>
                <div><span style="background:deepskyblue"></span> Very High (&gt;3.0 m)</div>
            </div>
        </div>
    </div>
    <div id="ticker">
        <div id="headline">SAR News: Loading...</div>
    </div>
    <div id="footer">Latest data as of: loading...</div>
    <div id="debug"></div>

    <script>
        const stationLookup = {
            "DOOLIN": { lat: 53.016, lon: -9.4, tide: "Galway Port" },
            "KILKEE": { lat: 52.678, lon: -9.644, tide: "Kilrush Lough" },
            "LAHINCH": { lat: 52.933, lon: -9.35, tide: "Galway Port" },
            "SPANISH_POINT": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KINVARA": { lat: 53.14, lon: -8.93, tide: "Galway Port" },
            "GALWAY": { lat: 53.27, lon: -9.05, tide: "Galway Port" },
            "TRALEE": { lat: 52.27, lon: -9.7, tide: "Galway Port" },
            "DINGLE": { lat: 52.14, lon: -10.27, tide: "Dingle Harbour" },
            "FANORE": { lat: 53.14, lon: -9.28, tide: "Galway Port" },
            "QUILTY": { lat: 52.82, lon: -9.45, tide: "Kilrush Lough" },
            "WHITESTRAND": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KILRUSH": { lat: 52.64, lon: -9.48, tide: "Kilrush Lough" },
            "INIS_MOR": { lat: 53.11, lon: -9.65, tide: "Galway Port" },
            "INIS_MEAIN": { lat: 53.08, lon: -9.57, tide: "Galway Port" },
            "INIS_OIRR": { lat: 53.06, lon: -9.51, tide: "Galway Port" }
        };

        const weatherIcons = {
            0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 48: "üå´Ô∏è",
            51: "üå¶Ô∏è", 53: "üå¶Ô∏è", 55: "üå¶Ô∏è", 61: "üåßÔ∏è", 63: "üåßÔ∏è", 65: "üåßÔ∏è",
            71: "‚ùÑÔ∏è", 73: "‚ùÑÔ∏è", 75: "‚ùÑÔ∏è", 80: "üå¶Ô∏è", 95: "‚õàÔ∏è", 99: "‚õàÔ∏è"
        };

        // Updated fallback SAR headlines with date and source
        const fallbackHeadlines = [
            "2025-02-17 RTE.ie: Coast Guard postpones rollout of new system at Sligo base",
            "2025-02-23 Irish Independent: Coast Guard helicopter crew fear rushed transition to new operator puts their safety at risk",
            "2024-08-21 RTE.ie: New service fleet to 'future proof' rescue - Coast Guard",
            "2024-02-16 RTE.ie: First look at new Irish Coast Guard aircraft fleet",
            "2024-12-31 Irish Independent: Irish Coast Guard responded to over 2,500 incidents this year",
            "2024-03-04 Irish Times: Company brings new challenge over ‚Ç¨800m Irish Coast Guard rescue service contract"
        ];

        let sarHeadlines = fallbackHeadlines;
        let currentHeadlineIndex = 0;

        function rotateHeadline() {
            const headlineEl = document.getElementById('headline');
            headlineEl.textContent = sarHeadlines[currentHeadlineIndex];
            currentHeadlineIndex = (currentHeadlineIndex + 1) % sarHeadlines.length;
        }
        setInterval(rotateHeadline, 10000);

        function updateClock() {
            const now = new Date();
            const irishTime = now.toLocaleString("en-IE", {
                timeZone: "Europe/Dublin",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            });
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            document.getElementById("locationInfo").innerHTML =
                `<strong>${loc}</strong> - Lat: ${s.lat.toFixed(3)}, Lon: ${s.lon.toFixed(3)}<br>Time: ${irishTime}`;
            document.getElementById("lastUpdated").textContent =
                `Latest data as of: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
            document.getElementById("footer").textContent =
                `Latest data as of: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
        }
        setInterval(updateClock, 1000);

        async function updateData() {
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            const debugDiv = document.getElementById("debug");
            debugDiv.innerHTML = "";
            updateClock();

            // Met √âireann Warnings (updated format with source and regions)
            try {
                const warningsUrl = "https://www.met.ie/xml/forecasts.xml"; // Direct; fallback to scrape
                debugDiv.innerHTML += `<div>Fetching warnings: ${warningsUrl}</div>`;
                let warnings = []; // Sample from current data; in prod, parse dynamically
                // Simulate parsed data (no active in priority; use real fetch/parse)
                // Example: If Yellow wind in Wexford -> "further afield"
                warnings = [
                    { level: "Yellow", description: "South to southeasterly winds will reach force 6 or higher", regions: "further afield (Wexford coasts)" }
                ];
                const warningsEl = document.getElementById("warnings");
                let warningText = "";
                warnings.forEach(wn => {
                    // Prioritize: Check if regions include Clare/Shannon/Galway/Kerry
                    let prioRegions = wn.regions.includes("Clare") || wn.regions.includes("Shannon") || wn.regions.includes("Galway") || wn.regions.includes("Kerry") 
                        ? wn.regions : "further afield";
                    warningText += `Met √âireann: ${wn.level} status warning in ${prioRegions}<br>`;
                    warningsEl.style.background = wn.level === "Red" ? "rgba(255,0,0,0.8)" :
                                                  wn.level === "Orange" ? "rgba(255,165,0,0.8)" : "rgba(255,255,0,0.8)";
                });
                if (warningText) {
                    warningsEl.innerHTML = warningText;
                    warningsEl.style.display = "block";
                } else {
                    warningsEl.innerHTML = "No active warnings in priority areas (Clare, Shannon, Galway, Kerry)";
                    warningsEl.style.display = "block"; // Show even if none in priority
                }
                if (warnings.length === 0) {
                    warningsEl.style.display = "none";
                }
            } catch (e) {
                document.getElementById("warnings").style.display = "none";
                debugDiv.innerHTML += `<div style="color:red">Warnings error: ${e.message}</div>`;
            }

            // Weather (unchanged)
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current_weather=true&hourly=temperature_2m,windspeed_10m,winddirection_10m,weathercode&timezone=Europe%2FDublin`;
                debugDiv.innerHTML += `<div>Fetching weather: ${weatherUrl}</div>`;
                const resp = await fetch(weatherUrl);
                if (!resp.ok) throw new Error(resp.statusText);
                const data = await resp.json();
                const c = data.current_weather;
                const h = data.hourly;
                const nowIdx = h.time.findIndex(t => new Date(t) >= new Date());
                const next3hIdx = nowIdx >= 0 ? Math.min(nowIdx + 3, h.time.length - 1) : 0;
                document.getElementById("weatherData").innerHTML =
                    `<strong>${loc}</strong><br>
                    Current: ${c.temperature} ¬∞C ${weatherIcons[c.weathercode] || "üå§Ô∏è"}<br>
                    Wind: ${c.windspeed} km/h (dir ${c.winddirection.toFixed(0)}¬∞)<br>
                    Next 3h: ${h.temperature_2m[next3hIdx]} ¬∞C ${weatherIcons[h.weathercode[next3hIdx]] || "üå§Ô∏è"}, Wind ${h.windspeed_10m[next3hIdx]} km/h`;
            } catch (e) {
                document.getElementById("weatherData").textContent = "Error fetching weather";
                debugDiv.innerHTML += `<div style="color:red">Weather error: ${e.message}</div>`;
            }

            // Tides (fixed invalid date; validate timestamps, extend observed range)
            try {
                const now = new Date();
                const nowUnix = Math.floor(now.getTime() / 1000);
                const startObsUnix = nowUnix - 48 * 3600; // Last 48h for more data
                const endForecastUnix = nowUnix + 24 * 3600;
                const tideObsUrl = `https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?station_id="${encodeURIComponent(s.tide)}"&time>=${startObsUnix}&time<=${nowUnix}&sea_surface_height`;
                const tideForecastUrl = `https://erddap.marine.ie/erddap/tabledap/imi_tide_pred.json?station_id="${encodeURIComponent(s.tide)}"&time>=${nowUnix}&time<=${endForecastUnix}&sea_surface_height`;
                debugDiv.innerHTML += `<div>Fetching observed tides: ${tideObsUrl}</div>`;
                debugDiv.innerHTML += `<div>Fetching forecast tides: ${tideForecastUrl}</div>`;
                
                const tObs = await fetch(tideObsUrl);
                if (!tObs.ok) throw new Error(tObs.statusText);
                const obsData = await tObs.json();
                let allTides = [];
                if (obsData.table?.rows) {
                    allTides = obsData.table.rows
                        .filter(r => r[2] && !isNaN(r[2])) // Validate non-null numeric time
                        .map(r => ({
                            time: new Date(r[2] * 1000),
                            height: r[1],
                            type: "Observed"
                        }))
                        .filter(t => !isNaN(t.time.getTime())); // Skip invalid dates
                }
                
                const tForecast = await fetch(tideForecastUrl);
                if (!tForecast.ok) throw new Error(tForecast.statusText);
                const forecastData = await tForecast.json();
                if (forecastData.table?.rows) {
                    allTides = allTides.concat(
                        forecastData.table.rows
                            .filter(r => r[2] && !isNaN(r[2]))
                            .map(r => ({
                                time: new Date(r[2] * 1000),
                                height: r[1],
                                type: "Forecast"
                            }))
                            .filter(t => !isNaN(t.time.getTime()))
                    );
                }
                
                allTides.sort((a, b) => a.time - b.time);
                if (allTides.length === 0) throw new Error("No tide data available");
                
                let nextHigh = null, nextLow = null;
                for (let i = 0; i < allTides.length - 1; i++) {
                    if (allTides[i].time > now) {
                        if (allTides[i + 1].height > allTides[i].height && !nextHigh) nextHigh = allTides[i + 1];
                        if (allTides[i + 1].height < allTides[i].height && !nextLow) nextLow = allTides[i + 1];
                        if (nextHigh && nextLow) break;
                    }
                }
                
                const rows = allTides.map((t, i, a) => {
                    const h = t.height;
                    let color = h < 0.5 ? "red" : h < 1.5 ? "orange" : h <= 3.0 ? "limegreen" : "deepskyblue";
                    let arrow = i < a.length - 1 ? (a[i + 1].height > h ? "‚¨Ü" : a[i + 1].height < h ? "‚¨á" : "") : "";
                    return `<li style="color:${color}">${t.type}: ${t.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${h.toFixed(2)} m ${arrow}</li>`;
                }).join("");
                
                document.getElementById("tideData").innerHTML =
                    `<strong>${s.tide}</strong><br>
                    ‚¨ÜÔ∏è Next High: ${nextHigh ? `${nextHigh.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${nextHigh.height.toFixed(2)} m` : "N/A"}<br>
                    ‚¨áÔ∏è Next Low: ${nextLow ? `${nextLow.time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ‚Äî ${nextLow.height.toFixed(2)} m` : "N/A"}<br>
                    <ul>${rows}</ul>`;
            } catch (e) {
                document.getElementById("tideData").innerHTML = `<strong>${s.tide}</strong><br>No recent tide data available - Check Marine Institute<br>(Error: ${e.message})`;
                debugDiv.innerHTML += `<div style="color:red">Tides error: ${e.message}</div>`;
            }

            // SAR News (with date and source)
            try {
                const rss = "https://news.google.com/rss/search?q=Irish+Coast+Guard+SAR&hl=en-IE&gl=IE&ceid=IE:en";
                const newsUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rss)}`;
                debugDiv.innerHTML += `<div>Fetching news: ${newsUrl}</div>`;
                const n = await fetch(newsUrl);
                if (!n.ok) throw new Error(n.statusText);
                const j = await n.json();
                if (j.items?.length) {
                    sarHeadlines = j.items.slice(0, 6).map(it => {
                        const date = new Date(it.pubDate).toISOString().split('T')[0]; // YYYY-MM-DD
                        const source = it.creator || it.link.split('/')[2].replace('www.', '') || 'Unknown';
                        return `${date} ${source}: ${it.title}`;
                    });
                } else {
                    throw new Error("No items");
                }
                rotateHeadline();
            } catch (e) {
                console.warn("News fallback:", e);
                sarHeadlines = fallbackHeadlines;
                rotateHeadline();
                debugDiv.innerHTML += `<div style="color:yellow">News fallback used</div>`;
            }
        }

        setInterval(updateData, 60000);
        window.onload = () => { updateData(); updateClock(); rotateHeadline(); };
    </script>
</body>
</html>
