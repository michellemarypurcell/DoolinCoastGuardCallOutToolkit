<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doolin Irish Coast Guard Unit - Active Call Out</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url('background.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        h1 {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            font-size: 3em;
            margin: 0;
            text-align: center;
        }
        #warnings {
            background: rgba(255, 165, 0, 0.8);
            padding: 15px;
            font-size: 1.8em;
            display: none;
            text-shadow: 1px 1px 2px black;
        }
        #locationBox {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 1em;
            z-index: 1000;
            display: block; /* Hide on mobile */
        }
        #locationBox label { font-weight: bold; margin-right: 5px; }
        #locationInfo {
            position: sticky;
            top: 0;
            z-index: 900;
            font-size: 1.5em;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-bottom: 2px solid #0077cc;
        }
        #lastUpdated {
            background: #0077cc;
            color: white;
            padding: 10px;
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
            align-content: start;
        }
        .widget {
            background: rgba(0, 0, 0, 0.65);
            padding: 20px;
            border-radius: 15px;
            font-size: 2.5em;
            text-align: center;
        }
        .widget h2 {
            margin-top: 0;
            font-size: 3em;
            text-align: center;
        }
        .legend { font-size: 1em; margin-top: 10px; }
        .legend span {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border-radius: 4px;
        }
        #ticker {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(0,0,0,0.8);
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 1.5em;
            white-space: nowrap;
            overflow: hidden;
        }
        #headline {
            animation: scroll 20s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        #debug {
            position: fixed;
            bottom: 70px;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            font-size: 0.9em;
            text-align: left;
            padding: 5px;
            max-height: 150px;
            overflow: auto;
            display: none; /* Show with 'block' for debugging */
        }
        #footer {
            background: rgba(0,0,0,0.7);
            padding: 10px;
            font-size: 1.2em;
        }
        ul { list-style: none; padding: 0; }
        li { margin: 10px 0; }

        /* Mobile adjustments (<768px) */
        @media (max-width: 768px) {
            body {
                height: auto;
                overflow-x: hidden;
            }
            h1 { font-size: 1.8em; padding: 10px; }
            #warnings { font-size: 1.2em; padding: 10px; }
            #locationBox { display: none; } /* Hide dropdown on mobile */
            #locationInfo { font-size: 1em; padding: 10px; }
            #lastUpdated { font-size: 1em; padding: 5px; }
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
                gap: 10px;
            }
            .widget {
                width: 100%;
                font-size: 1.2em;
                padding: 10px;
            }
            .widget h2 { font-size: 1.8em; }
            #ticker { height: 40px; font-size: 1em; }
            #footer { font-size: 0.9em; padding: 5px; }
            .legend { font-size: 0.8em; }
        }
    </style>
</head>
<body>
    <h1>Doolin Irish Coast Guard Unit - Active Call Out</h1>
    <div id="warnings">No active warnings</div>
    <div id="locationBox">
        <label for="location">Change location:</label>
        <select id="location" onchange="updateData()">
            <option value="DOOLIN" selected>Doolin Port</option>
            <option value="KILKEE">Kilkee</option>
            <option value="LAHINCH">Lahinch</option>
            <option value="SPANISH_POINT">Spanish Point</option>
            <option value="KINVARA">Kinvara</option>
            <option value="GALWAY">Galway</option>
            <option value="TRALEE">Tralee</option>
            <option value="DINGLE">Dingle</option>
            <option value="FANORE">Fanore</option>
            <option value="QUILTY">Quilty</option>
            <option value="WHITESTRAND">Whitestrand</option>
            <option value="KILRUSH">Kilrush</option>
            <option value="INIS_MOR">Inis M√≥r</option>
            <option value="INIS_MEAIN">Inis Me√°in</option>
            <option value="INIS_OIRR">Inis O√≠rr</option>
        </select>
    </div>
    <div id="locationInfo">Loading location info‚Ä¶</div>
    <div id="lastUpdated">Last updated: loading‚Ä¶</div>
    <div class="container">
        <div class="widget">
            <h2>Weather</h2>
            <div id="weatherData">Loading...</div>
        </div>
        <div class="widget">
            <h2>Tides</h2>
            <div id="tideData">Loading...</div>
            <div class="legend">
                <div><span style="background:red"></span> Low (&lt;0.5 m)</div>
                <div><span style="background:orange"></span> Caution (0.5‚Äì1.5 m)</div>
                <div><span style="background:limegreen"></span> Good (1.5‚Äì3.0 m)</div>
                <div><span style="background:deepskyblue"></span> Very High (&gt;3.0 m)</div>
            </div>
        </div>
    </div>
    <div id="ticker">
        <div id="headline">SAR News: Loading...</div>
    </div>
    <div id="footer">Latest data as of: loading...</div>
    <div id="debug"></div>

    <script>
        const stationLookup = {
            "DOOLIN": { lat: 53.016, lon: -9.4, tide: "Galway Port" },
            "KILKEE": { lat: 52.678, lon: -9.644, tide: "Kilrush Lough" },
            "LAHINCH": { lat: 52.933, lon: -9.35, tide: "Galway Port" },
            "SPANISH_POINT": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KINVARA": { lat: 53.14, lon: -8.93, tide: "Galway Port" },
            "GALWAY": { lat: 53.27, lon: -9.05, tide: "Galway Port" },
            "TRALEE": { lat: 52.27, lon: -9.7, tide: "Galway Port" },
            "DINGLE": { lat: 52.14, lon: -10.27, tide: "Dingle Harbour" },
            "FANORE": { lat: 53.14, lon: -9.28, tide: "Galway Port" },
            "QUILTY": { lat: 52.82, lon: -9.45, tide: "Kilrush Lough" },
            "WHITESTRAND": { lat: 52.85, lon: -9.42, tide: "Kilrush Lough" },
            "KILRUSH": { lat: 52.64, lon: -9.48, tide: "Kilrush Lough" },
            "INIS_MOR": { lat: 53.11, lon: -9.65, tide: "Galway Port" },
            "INIS_MEAIN": { lat: 53.08, lon: -9.57, tide: "Galway Port" },
            "INIS_OIRR": { lat: 53.06, lon: -9.51, tide: "Galway Port" }
        };

        const weatherIcons = {
            0: "‚òÄÔ∏è", 1: "üå§Ô∏è", 2: "‚õÖ", 3: "‚òÅÔ∏è", 45: "üå´Ô∏è", 48: "üå´Ô∏è",
            51: "üå¶Ô∏è", 53: "üå¶Ô∏è", 55: "üå¶Ô∏è", 61: "üåßÔ∏è", 63: "üåßÔ∏è", 65: "üåßÔ∏è",
            71: "‚ùÑÔ∏è", 73: "‚ùÑÔ∏è", 75: "‚ùÑÔ∏è", 80: "üå¶Ô∏è", 95: "‚õàÔ∏è", 99: "‚õàÔ∏è"
        };

        const fallbackHeadlines = [
            "Coast Guard postpones rollout of new system at Sligo base - RTE.ie",
            "Irish Coast Guard Director Says He Has Full Confidence In New SAR Service - Afloat",
            "Minister Canny Announces Agreement on Irish Coast Guard Air Handover - The Fishing Daily",
            "Search and rescue operations by Coast Guard relocated to Weston - Echo.ie",
            "A change in the company managing the Coast Guard's rescue contract has been pushed back to 2026 - The Journal"
        ];

        let sarHeadlines = fallbackHeadlines;
        let currentHeadlineIndex = 0;

        function rotateHeadline() {
            const headlineEl = document.getElementById('headline');
            headlineEl.textContent = sarHeadlines[currentHeadlineIndex];
            currentHeadlineIndex = (currentHeadlineIndex + 1) % sarHeadlines.length;
        }
        setInterval(rotateHeadline, 10000);

        function updateClock() {
            const now = new Date();
            const irishTime = now.toLocaleString("en-IE", {
                timeZone: "Europe/Dublin",
                hour: "2-digit",
                minute: "2-digit",
                second: "2-digit",
                hour12: false
            });
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            document.getElementById("locationInfo").innerHTML =
                `<strong>${loc}</strong> - Lat: ${s.lat.toFixed(3)}, Lon: ${s.lon.toFixed(3)}<br>Time: ${irishTime}`;
            document.getElementById("lastUpdated").textContent =
                `Last updated: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
            document.getElementById("footer").textContent =
                `Latest data as of: ${now.toLocaleString("en-IE", { timeZone: "Europe/Dublin" })}`;
        }
        setInterval(updateClock, 1000);

        async function updateData() {
            const loc = document.getElementById("location").value;
            const s = stationLookup[loc];
            const debugDiv = document.getElementById("debug");
            debugDiv.innerHTML = "";
            updateClock();

            // Met √âireann Warnings (direct XML with fallback proxy)
            try {
                const warningsUrl = "https://www.met.ie/xml/forecasts.xml"; // Direct endpoint; adjust if needed
                debugDiv.innerHTML += `<div>Fetching warnings: ${warningsUrl}</div>`;
                const w = await fetch(warningsUrl);
                if (!w.ok) {
                    const fallbackUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://www.met.ie/warnings");
                    const fw = await fetch(fallbackUrl);
                    if (!fw.ok) throw new Error(fw.statusText);
                    const html = await fw.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const warningEls = doc.querySelectorAll('.warning-item, .warning, [class*="warning"]');
                    const warnings = [];
                    warningEls.forEach(el => {
                        const level = el.className.includes('yellow') ? 'Yellow' : el.className.includes('orange') ? 'Orange' : el.className.includes('red') ? 'Red' : null;
                        if (level) {
                            const headline = el.querySelector('h3, .title, .headline')?.textContent || el.textContent.trim();
                            warnings.push({ level, headline });
                        }
                    });
                    const warningsEl = document.getElementById("warnings");
                    let warningText = "";
                    warnings.forEach(wn => {
                        warningText += `${wn.level} WARNING: ${wn.headline}<br>`;
                        warningsEl.style.background = wn.level === "Red" ? "rgba(255,0,0,0.8)" :
                                                      wn.level === "Orange" ? "rgba(255,165,0,0.8)" : "rgba(255,255,0,0.8)";
                    });
                    if (warningText) {
                        warningsEl.innerHTML = warningText;
                        warningsEl.style.display = "block";
                    } else {
                        warningsEl.style.display = "none";
                    }
                } else {
                    const xmlText = await w.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xmlText, "text/xml");
                    const warnings = doc.querySelectorAll("warning");
                    const warningsEl = document.getElementById("warnings");
                    let warningText = "";
                    warnings.forEach(w => {
                        const level = w.querySelector("level")?.textContent;
                        if (["Yellow", "Orange", "Red"].includes(level)) {
                            const headline = w.querySelector("headline")?.textContent || "Warning active";
                            warningText += `${level} WARNING: ${headline}<br>`;
                            warningsEl.style.background = level === "Red" ? "rgba(255,0,0,0.8)" :
                                                  level === "Orange" ? "rgba(255,165,0,0.8)" : "rgba(255,255,0,0.8)";
                        }
                    });
                    if (warningText) {
                        warningsEl.innerHTML = warningText;
                        warningsEl.style.display = "block";
                    } else {
                        warningsEl.style.display = "none";
                    }
                }
            } catch (e) {
                document.getElementById("warnings").style.display = "none";
                debugDiv.innerHTML += `<div style="color:red">Warnings error: ${e.message}</div>`;
            }

            // Weather
            try {
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${s.lat}&longitude=${s.lon}&current_weather=true&hourly=temperature_2m,windspeed_10m,winddirection_10m,weathercode&timezone=Europe%2FDublin`;
                debugDiv.innerHTML += `<div>Fetching weather: ${weatherUrl}</div>`;
                const resp = await fetch(weatherUrl);
                if (!resp.ok) throw new Error(resp.statusText);
                const data = await resp.json();
                const c = data.current_weather;
                const h = data.hourly;
                const nowIdx = h.time.findIndex(t => new Date(t) >= new Date());
                const next3hIdx = nowIdx >= 0 ? Math.min(nowIdx + 3, h.time.length - 1) : 0;
                document.getElementById("weatherData").innerHTML =
                    `<strong>${loc}</strong><br>
                    Current: ${c.temperature} ¬∞C ${weatherIcons[c.weathercode] || "üå§Ô∏è"}<br>
                    Wind: ${c.windspeed} km/h (dir ${c.winddirection.toFixed(0)}¬∞)<br>
                    Next 3h: ${h.temperature_2m[next3hIdx]} ¬∞C ${weatherIcons[h.weathercode[next3hIdx]] || "üå§Ô∏è"}, Wind ${h.windspeed_10m[next3hIdx]} km/h`;
            } catch (e) {
                document.getElementById("weatherData").textContent = "Error fetching weather";
                debugDiv.innerHTML += `<div style="color:red">Weather error: ${e.message}</div>`;
            }

            // Tides (Observed last 24h + Forecast next 24h)
            try {
                const now = new Date();
                const nowUnix = Math.floor(now.getTime() / 1000);
                const startObsUnix = nowUnix - 24 * 3600;
                const endForecastUnix = nowUnix + 24 * 3600;
                const tideObsUrl = `https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?station_id="${encodeURIComponent(s.tide)}"&time>=${startObsUnix}&time<=${nowUnix}&sea_surface_height`;
                const tideForecastUrl = `https://erddap.marine.ie/erddap/tabledap/imi_tide_pred.json?station_id="${encodeURIComponent(s.tide)}"&time
