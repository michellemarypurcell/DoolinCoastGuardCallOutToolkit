<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Doolin Irish Coast Guard Unit - Latest data for active call out</title>
<style>
body {
font-family: Arial, sans-serif;
background: url('background.jpg') no-repeat center center fixed;
background-size: cover;
color: #fff;
text-align: center;
margin: 0;
padding: 0;
}

h1 {
background: rgba(0, 0, 0, 0.6);
padding: 20px;
font-size: 2.5em;
margin: 0;
}

#locationBox {
position: absolute;
top: 10px;
right: 10px;
background: rgba(0,0,0,0.5);
padding: 5px 10px;
border-radius: 8px;
font-size: 0.9em;
z-index: 1000;
}

#locationBox label {
font-weight: bold;
margin-right: 5px;
}

#subtitle {
font-size: 1.4em;
margin-bottom: 10px;
}

/* Sticky Location Info Box */
#locationInfo {
position: sticky;
top: 0;
z-index: 900;
font-size: 1.2em;
margin: 0;
background: rgba(0,0,0,0.8);
padding: 12px;
border-bottom: 2px solid #0077cc;
}

#lastUpdated {
background: #0077cc;
color: white;
padding: 5px;
font-size: 1.2em;
margin-bottom: 20px;
}

.container {
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
gap: 40px;
margin: 20px auto;
max-width: 1200px;
}

.widget {
background: rgba(0, 0, 0, 0.65);
padding: 40px;
border-radius: 15px;
width: 90%;
max-width: 900px;
font-size: 1.8em;
text-align: left;
}

.widget h2 {
margin-top: 0;
font-size: 2.2em;
text-align: center;
}

/* Legend styling */
.legend {
font-size: 0.9em;
margin-top: 10px;
}
.legend span {
display: inline-block;
width: 18px;
height: 18px;
margin-right: 6px;
border-radius: 4px;
}
#debug {
position: fixed;
bottom: 0;
left: 0;
width: 100%;
background: rgba(0,0,0,0.7);
color: #0f0;
font-size: 0.8em;
text-align: left;
padding: 5px;
max-height: 150px;
overflow:auto;
}
</style>
</head>
<body>
<h1>Doolin Irish Coast Guard Unit - Latest data for active call out</h1>

<div id="locationBox">
<label for="location">Change location:</label>
<select id="location" onchange="updateData()">
<option value="DOOLIN" selected>Doolin Port</option>
<option value="KILKEE">Kilkee</option>
<option value="LAHINCH">Lahinch</option>
<option value="SPANISH_POINT">Spanish Point</option>
<option value="KINVARA">Kinvara</option>
<option value="GALWAY">Galway</option>
<option value="TRALEE">Tralee</option>
<option value="DINGLE">Dingle</option>
<option value="FANORE">Fanore</option>
<option value="QUILTY">Quilty</option>
<option value="WHITESTRAND">Whitestrand</option>
<option value="KILRUSH">Kilrush</option>
<option value="INIS_MOR">Inis Mór</option>
<option value="INIS_MEAIN">Inis Meáin</option>
<option value="INIS_OIRR">Inis Oírr</option>
</select>
</div>

<div id="subtitle">Data for </div>

<!-- Sticky info box -->
<div id="locationInfo">Loading location info…</div>

<div id="lastUpdated">Last updated: loading…</div>

<div class="container">
<div class="widget">
<h2>Weather</h2>
<div id="weatherData">Loading...</div>
</div>

<div class="widget">
<h2>Tides</h2>
<div id="tideData">Loading...</div>
<!-- Tide Legend -->
<div class="legend">
<div><span style="background:red"></span> Low (&lt;0.5 m)</div>
<div><span style="background:orange"></span> Caution (0.5–1.5 m)</div>
<div><span style="background:limegreen"></span> Good (1.5–3.0 m)</div>
<div><span style="background:deepskyblue"></span> Very High (&gt;3.0 m)</div>
</div>
</div>

<div class="widget">
<h2>SAR News</h2>
<div id="newsData">Loading...</div>
</div>
</div>

<div id="debug"></div>

<script>
// Map locations to coordinates + tide stations
const stationLookup = {
"DOOLIN": { lat: 53.016, lon: -9.4, tide: "GALWAY_PORT" },
"KILKEE": { lat: 52.678, lon: -9.644, tide: "KILRUSH" },
"LAHINCH": { lat: 52.933, lon: -9.35, tide: "GALWAY_PORT" },
"SPANISH_POINT": { lat: 52.85, lon: -9.42, tide: "KILRUSH" },
"KINVARA": { lat: 53.14, lon: -8.93, tide: "GALWAY_PORT" },
"GALWAY": { lat: 53.27, lon: -9.05, tide: "GALWAY_PORT" },
"TRALEE": { lat: 52.27, lon: -9.7, tide: "FENIT" },
"DINGLE": { lat: 52.14, lon: -10.27, tide: "VALENTIA" },
"FANORE": { lat: 53.14, lon: -9.28, tide: "GALWAY_PORT" },
"QUILTY": { lat: 52.82, lon: -9.45, tide: "KILRUSH" },
"WHITESTRAND": { lat: 52.85, lon: -9.42, tide: "KILRUSH" },
"KILRUSH": { lat: 52.64, lon: -9.48, tide: "KILRUSH" },
"INIS_MOR": { lat: 53.11, lon: -9.65, tide: "GALWAY_PORT" },
"INIS_MEAIN": { lat: 53.08, lon: -9.57, tide: "GALWAY_PORT" },
"INIS_OIRR": { lat: 53.06, lon: -9.51, tide: "GALWAY_PORT" }
};

// Helper: strip ms + force Z
function isoNoMs(date) {
return date.toISOString().split('.')[0] + "Z";
}

async function updateData() {
const loc = document.getElementById("location").value;
const station = stationLookup[loc];
const debugDiv = document.getElementById("debug");
debugDiv.innerHTML = "";

document.getElementById("subtitle").textContent = `Data for ${loc}`;
const now = new Date();
document.getElementById("lastUpdated").textContent =
`Last updated: ${now.toLocaleString()}`;

// Location info (sticky header)
const localTime = now.toLocaleString("en-IE", {
timeZone: "Europe/Dublin",
weekday: "short",
day: "numeric",
month: "short",
hour: "2-digit",
minute: "2-digit"
});
document.getElementById("locationInfo").innerHTML = `
<strong>${loc}</strong><br>
Lat: ${station.lat.toFixed(3)}, Lon: ${station.lon.toFixed(3)}<br>
${localTime}
`;

// WEATHER (Open-Meteo)
try {
const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${station.lat}&longitude=${station.lon}&current_weather=true`;
debugDiv.innerHTML += `<div>Fetching weather: ${weatherUrl}</div>`;
const w = await fetch(weatherUrl);
const weather = await w.json();
const c = weather.current_weather;
document.getElementById("weatherData").innerHTML = `
<strong>${loc}</strong><br>
Temp: ${c.temperature} °C<br>
Wind: ${c.windspeed} km/h (dir ${c.winddirection}°)<br>
Time: ${c.time}
`;
} catch (e) {
document.getElementById("weatherData").textContent = "Error fetching weather.";
debugDiv.innerHTML += `<div style="color:red">Weather error: ${e}</div>`;
}

// TIDES (Marine Institute ERDDAP) with colour coding + trend arrows
try {
const start = new Date();
const end = new Date(start.getTime() + 12 * 3600 * 1000);
const startISO = isoNoMs(start);
const endISO = isoNoMs(end);
const tideUrl =
`https://erddap.marine.ie/erddap/tabledap/IrishNationalTideGaugeNetwork.json?station_id,sea_surface_height,time&station_id=${station.tide}&time>=${startISO}&time<=${endISO}`;
debugDiv.innerHTML += `<div>Fetching tides: ${tideUrl}</div>`;
const t = await fetch(tideUrl);
const tides = await t.json();
if (tides.table.rows.length === 0) throw "No tide data available";

const rows = tides.table.rows.map((r, i, arr) => {
const [id, height, time] = r;
let color = "white";
if (height < 0.5) color = "red";
else if (height < 1.5) color = "orange";
else if (height <= 3.0) color = "limegreen";
else color = "deepskyblue";

// Trend arrow
let arrow = "";
if (i < arr.length - 1) {
const nextHeight = arr[i + 1][1];
if (nextHeight > height) arrow = "⬆";
else if (nextHeight < height) arrow = "⬇";
}

return `<li style="color:${color}">
${new Date(time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} —
${height.toFixed(2)} m ${arrow}
</li>`;
}).join("");
document.getElementById("tideData").innerHTML =
`<strong>${station.tide}</strong><br><ul style="list-style:none; padding:0">${rows}</ul>`;
} catch (e) {
document.getElementById("tideData").textContent = "Error fetching tides.";
debugDiv.innerHTML += `<div style="color:red">Tide error: ${e}</div>`;
}

// SAR NEWS (via rss2json proxy)
try {
const rssUrl = "https://news.google.com/rss/search?q=Irish+Coast+Guard+SAR&hl=en-IE&gl=IE&ceid=IE:en";
const newsUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}`;
debugDiv.innerHTML += `<div>Fetching news: ${newsUrl}</div>`;
let n = await fetch(newsUrl);
let newsJson = await n.json();

if (!newsJson.items || newsJson.items.length === 0) {
// fallback RNLI
const rnliUrl = "https://api.rss2json.com/v1/api.json?rss_url=" + encodeURIComponent("https://rnli.org/news-and-media/rss-feeds/latest-news");
debugDiv.innerHTML += `<div>Fetching RNLI news: ${rnliUrl}</div>`;
n = await fetch(rnliUrl);
newsJson = await n.json();
}

let html = "<ul style='list-style:none; padding:0'>";
newsJson.items.slice(0,5).forEach(item => {
html += `<li><a href="${item.link}" target="_blank" style="color:#fff">${item.title}</a></li>`;
});
html += "</ul>";
document.getElementById("newsData").innerHTML = html;
} catch (e) {
document.getElementById("newsData").textContent = "Error fetching news.";
debugDiv.innerHTML += `<div style="color:red">News error: ${e}</div>`;
}
}

// refresh every 60s
setInterval(updateData, 60000);
window.onload = updateData;
</script>
</body>
</html>
