<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doolin CG Call-out Operations</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body{margin:0;background:#0b0b0b;color:#fff;font-family:Segoe UI,Arial,sans-serif;overflow:hidden}
  header{padding:16px;background:#111;text-align:center;border-bottom:3px solid #2aa3ff}
  h1{margin:0;font-size:2.2rem}
  #sarIncident{background:rgba(220,0,0,0.85);padding:14px;margin:10px;border-radius:10px;text-align:center}
  #sarIncident h2{margin:0 0 8px;font-size:1.4rem}
  #incidentDetails{font-size:1.2rem;font-weight:600}
  #infoBar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#141414;
    padding:10px;border-top:1px solid #222;border-bottom:1px solid #222}
  #locName{font-weight:800}
  #latlon{color:#ddd}
  #locationSelect{background:#0f0f0f;color:#fff;border:1px solid #333;padding:6px;border-radius:8px}
  #mapBox{margin:10px}
  #map{height:200px;border-radius:8px;border:2px solid #333}
  main{display:flex;gap:20px;padding:16px;height:calc(100vh - 280px);box-sizing:border-box}
  .panel{flex:1 1 50%;background:#1c1c1c;border-radius:12px;padding:16px;display:flex;flex-direction:column;justify-content:center}
  .panel h2{text-align:center;margin:0 0 14px;font-size:1.6rem}
  .status-dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-left:6px;background:#666}
  /* Weather visuals */
  #weatherIcon{font-size:4.5rem;text-align:center;margin-bottom:10px}
  #weatherData{font-size:1.4rem;text-align:center;line-height:1.6}
  #compass{position:relative;width:120px;height:120px;border-radius:50%;border:4px solid rgba(255,255,255,0.25);margin:12px auto}
  #compassArrow{position:absolute;left:50%;top:50%;width:8px;height:50px;background:red;border-radius:4px;
    transform-origin:50% 85%;transform:translate(-50%,-50%) rotate(0deg)}
  .compass-label{position:absolute;font-size:1rem;font-weight:800;opacity:.9}
  .n{left:50%;top:-20px;transform:translateX(-50%);color:red}
  .s{left:50%;bottom:-20px;transform:translateX(-50%)}
  .e{right:-20px;top:50%;transform:translateY(-50%)}
  .w{left:-20px;top:50%;transform:translateY(-50%)}
  #windText{text-align:center;font-size:1.2rem;margin-top:6px}
  /* Tide visuals */
  #tideChart{height:160px;display:flex;align-items:flex-end;gap:8px;justify-content:center;margin-top:12px}
  .bar{flex:1;min-width:40px;text-align:center;color:#fff;font-size:0.9rem;font-weight:600;border-radius:6px 6px 0 0;display:flex;flex-direction:column;justify-content:flex-end}
  .bar span{background:rgba(0,0,0,0.4);width:100%;padding:2px;border-radius:0 0 6px 6px}
  #nextTide{margin-top:10px;text-align:center;font-weight:700;font-size:1.3rem;line-height:1.6}
  #nextTide .high{color:deepskyblue}
  #nextTide .low{color:red}
  #tideSource{text-align:center;margin-top:6px;font-size:0.9rem;color:#aaa}
  footer{text-align:center;padding:12px;background:#111;color:#ddd;font-size:1.1rem}
  #debug{display:none}
  @media(max-width:800px){
    main{flex-direction:column;height:auto}
    .panel{flex:1 1 auto}
    body{overflow:auto}
  }
</style>
</head>
<body>
<header><h1>Doolin CG Call-out Operations</h1></header>

<section id="sarIncident">
  <h2>Latest Coast Guard Incident</h2>
  <div id="incidentDetails"><p>No active incident entered.</p></div>
</section>

<div id="infoBar">
  <div><span id="locName">Doolin Port</span> ‚Äî <span id="latlon">Lat: 53.016, Lon: -9.400</span></div>
  <div>
    <label for="locationSelect">Location:</label>
    <select id="locationSelect"></select>
    <span id="clock">Current time: --:--:--</span>
  </div>
</div>

<div id="mapBox"><div id="map"></div></div>

<main>
  <section class="panel">
    <h2>Weather <span id="weatherStatus" class="status-dot"></span></h2>
    <div id="weatherIcon">‚òÄÔ∏è</div>
    <div id="weatherData">Loading‚Ä¶</div>
    <div id="compass">
      <div class="compass-label n">N</div>
      <div class="compass-label s">S</div>
      <div class="compass-label e">E</div>
      <div class="compass-label w">W</div>
      <div id="compassArrow"></div>
    </div>
    <div id="windText"></div>
  </section>
  <section class="panel">
    <h2>Tide Forecast <span id="tideStatus" class="status-dot"></span></h2>
    <div id="tideChart">Loading‚Ä¶</div>
    <div id="nextTide"></div>
    <div id="tideSource"></div>
  </section>
</main>

<footer>
  <div id="latestData">Latest data as of: --</div>
</footer>

<pre id="debug"></pre>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
function qs(id){return document.getElementById(id);}

/* Locations */
const LOCS={
 "DOOLIN":       {name:"Doolin Port", lat:53.016, lon:-9.4,   station:"Inishmore"},
 "BALLYVAUGHAN": {name:"Ballyvaughan", lat:53.120, lon:-9.150, station:"Galway_Port"},
 "FANORE":       {name:"Fanore", lat:53.14, lon:-9.28,  station:"Inishmore"},
 "QUILTY":       {name:"Quilty", lat:52.82, lon:-9.45,  station:"Kilrush"},
 "KILKEE":       {name:"Kilkee", lat:52.678, lon:-9.644, station:"Kilrush"},
 "LAHINCH":      {name:"Lahinch", lat:52.933, lon:-9.35, station:"Inishmore"},
 "SPANISH_PT":   {name:"Spanish Point", lat:52.85, lon:-9.42, station:"Kilrush"},
 "WHITESTRAND":  {name:"Whitestrand", lat:52.85, lon:-9.42, station:"Kilrush"},
 "KILRUSH":      {name:"Kilrush", lat:52.64, lon:-9.48, station:"Kilrush"},
 "KINVARA":      {name:"Kinvara", lat:53.14, lon:-8.93, station:"Galway_Port"},
 "GALWAY":       {name:"Galway", lat:53.27, lon:-9.05, station:"Galway_Port"},
 "INIS_MOR":     {name:"Inis M√≥r", lat:53.11, lon:-9.65, station:"Inishmore"},
 "INIS_MEAIN":   {name:"Inis Me√°in", lat:53.08, lon:-9.57, station:"Inishmaan"},
 "INIS_OIRR":    {name:"Inis O√≠rr", lat:53.06, lon:-9.51, station:"Inisheer"}
};
const sel=qs("locationSelect");
for(const k in LOCS){const o=document.createElement("option");o.value=k;o.textContent=LOCS[k].name;if(k==="DOOLIN")o.selected=true;sel.appendChild(o);}
let CUR=LOCS["DOOLIN"];
sel.onchange=()=>{CUR=LOCS[sel.value];updateAll();};

let map, marker;
function setCurrent(loc){
  CUR=LOCS[loc];
  qs("locName").textContent=CUR.name;
  qs("latlon").textContent="Lat: "+CUR.lat.toFixed(3)+", Lon: "+CUR.lon.toFixed(3);
  if(!map){
    map=L.map('map').setView([CUR.lat,CUR.lon],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);
    marker=L.marker([CUR.lat,CUR.lon]).addTo(map);
  } else {
    map.setView([CUR.lat,CUR.lon],11);
    marker.setLatLng([CUR.lat,CUR.lon]);
  }
}

/* Clock */
setInterval(()=>{qs("clock").textContent="Current time: "+new Date().toLocaleTimeString("en-IE",{hour12:false});},1000);

/* Weather */
function compassDir(deg){const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return dirs[Math.round(deg/22.5)%16];}
function iconForCode(c){if(c===0)return"‚òÄÔ∏è";if([1,2,3].includes(c))return"üå§";if([45,48].includes(c))return"üå´";if([51,53,55,56,57,61,63,65,66,67].includes(c))return"üå¶";if([71,73,75,77].includes(c))return"‚ùÑÔ∏è";if([80,81,82].includes(c))return"üåß";if([95,96,99].includes(c))return"‚õà";return"‚ùì";}
function loadWeather(){
  const u=`https://api.open-meteo.com/v1/forecast?latitude=${CUR.lat}&longitude=${CUR.lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,weathercode&timezone=Europe%2FDublin`;
  fetch(u).then(r=>r.json()).then(j=>{
    if(!j.current){qs("weatherData").textContent="No weather";qs("weatherStatus").style.background="red";return;}
    const c=j.current;
    qs("weatherIcon").textContent=iconForCode(c.weathercode);
    qs("weatherData").innerHTML=`<b>${c.temperature_2m}¬∞C</b><br>Wind: ${c.wind_speed_10m} km/h`;
    qs("compassArrow").style.transform=`translate(-50%,-50%) rotate(${c.wind_direction_10m}deg)`;
    qs("windText").textContent=`${c.wind_direction_10m}¬∞ ${compassDir(c.wind_direction_10m)}`;
    qs("weatherStatus").style.background="green";
  }).catch(e=>{qs("weatherData").textContent="Weather error";qs("weatherStatus").style.background="red";});
}

/* Tides via thingproxy with status dot */
function tideColor(h){if(h<0.5)return"red";if(h<1.5)return"orange";if(h<=3.0)return"limegreen";return"deepskyblue";}
async function loadTide(){
  if(!CUR.station){qs("tideChart").textContent="‚ö†Ô∏è No tide station";qs("tideStatus").style.background="red";return;}
  const nowISO=new Date().toISOString();
  const url=`https://erddap.marine.ie/erddap/tabledap/IMI_TidePrediction.json?stationID,time,Prediction&stationID=${encodeURIComponent(CUR.station)}&time>=${nowISO}`;
  const proxiedUrl="https://thingproxy.freeboard.io/fetch/"+url;
  try{
    const r=await fetch(proxiedUrl);
    const txt=await r.text();
    let j;
    try{ j=JSON.parse(txt); }catch(e){ qs("tideChart").textContent="‚ö†Ô∏è Tide server error"; qs("tideStatus").style.background="red"; return; }
    const rows=j.table?.rows||[];
    if(!rows.length){qs("tideChart").textContent=`‚ö†Ô∏è No tide predictions for ${CUR.station}`;qs("tideStatus").style.background="yellow";return;}
    const now=new Date();
    const future=rows.filter(r=>new Date(r[1])>=now).slice(0,6);
    if(!future.length){qs("tideChart").textContent="‚ö†Ô∏è No upcoming tide predictions.";qs("tideStatus").style.background="yellow";return;}
    const heights=future.map(r=>parseFloat(r[2]));
    const maxH=Math.max(...heights),minH=Math.min(...heights);
    const highRow=future[heights.indexOf(maxH)],lowRow=future[heights.indexOf(minH)];
    const bars=future.map((r,i)=>{
      const t=new Date(r[1]).toLocaleTimeString("en-IE",{hour:'2-digit',minute:'2-digit',hour12:false});
      const h=parseFloat(r[2]);
      const isHigh=(h===maxH),isLow=(h===minH);
      const icon=isHigh?"üåä":isLow?"‚¨áÔ∏è":"";
      let trend="",bgColor=tideColor(h);
      if(i<future.length-1){
        const nextH=parseFloat(future[i+1][2]);
        if(nextH>h){trend="‚¨ÜÔ∏è";bgColor=`linear-gradient(to top, deepskyblue, ${tideColor(h)})`;}
        else if(nextH<h){trend="‚¨áÔ∏è";bgColor=`linear-gradient(to top, #555, ${tideColor(h)})`;}
      }
      return `<div class="bar" style="height:${h*40}px;background:${bgColor}">
                <div style="font-size:1.4rem">${icon}</div>
                <span>${t}<br>${h.toFixed(2)}m ${trend}</span>
              </div>`;
    }).join("");
    qs("tideChart").innerHTML=bars;
    const highTime=new Date(highRow[1]).toLocaleTimeString("en-IE",{hour:'2-digit',minute:'2-digit',hour12:false});
    const lowTime=new Date(lowRow[1]).toLocaleTimeString("en-IE",{hour:'2-digit',minute:'2-digit',hour12:false});
    qs("nextTide").innerHTML=`<span class="high"><b>Next High Tide:</b> ${highTime} ‚Äî ${maxH.toFixed(2)} m üåä</span><br>
                              <span class="low"><b>Next Low Tide:</b> ${lowTime} ‚Äî ${minH.toFixed(2)} m ‚¨áÔ∏è</span>`;
    qs("tideSource").textContent=`Source: ${CUR.station}`;
    qs("tideStatus").style.background="green";
  }catch(e){qs("tideChart").textContent="‚ö†Ô∏è Tide fetch failed";qs("tideStatus").style.background="red";}
}

/* Refresh */
function updateAll(){
  setCurrent(sel.value);
  const now=new Date();
  qs("latestData").textContent="Latest data as of: "+now.toLocaleTimeString("en-IE",{hour12:false});
  loadWeather();loadTide();
}
updateAll();setInterval(updateAll,60000);
</script>
</body>
</html>
