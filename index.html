<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doolin CG Call-out Operations</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{--pad:16px;--panel:#1c1c1c;--ink:#fff;--sub:#ddd}
  *{box-sizing:border-box}
  body{margin:0;background:#0b0b0b;color:var(--ink);font-family:Segoe UI,Arial,sans-serif;overflow:hidden}
  header{padding:var(--pad);background:#111;border-bottom:3px solid #2aa3ff;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:2.0rem}
  #adminBtn{background:#2aa3ff;border:none;color:#fff;font-weight:700;padding:8px 12px;border-radius:8px;cursor:pointer}
  #sarIncident{background:rgba(220,0,0,0.85);padding:12px;margin:10px;border-radius:10px;text-align:center}
  #sarIncident h2{margin:0 0 6px;font-size:1.2rem}
  #incidentDetails{font-size:1.05rem;font-weight:600}
  #incidentAdmin{display:none;margin-top:10px;text-align:center}
  #incidentAdmin input{padding:6px;margin:4px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff}
  #incidentAdmin button{padding:6px 12px;border:none;border-radius:6px;background:#2aa3ff;color:#fff;font-weight:600;cursor:pointer}
  #infoBar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#141414;
    padding:10px;border-top:1px solid #222;border-bottom:1px solid #222}
  #locName{font-weight:800}
  #latlon{color:var(--sub)}
  #locationSelect{background:#0f0f0f;color:#fff;border:1px solid #333;padding:6px;border-radius:8px}
  main{display:flex;gap:20px;padding:var(--pad);height:48vh;min-height:360px}
  .panel{flex:1 1 50%;background:var(--panel);border-radius:12px;padding:16px;display:flex;flex-direction:column;justify-content:center}
  .panel h2{text-align:center;margin:0 0 10px;font-size:1.3rem}
  .status-dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-left:6px;background:#666;vertical-align:middle}
  /* Weather visuals */
  #weatherIcon{font-size:3.8rem;text-align:center;margin-bottom:8px}
  #weatherData{font-size:1.2rem;text-align:center;line-height:1.5}
  #compass{position:relative;width:110px;height:110px;border-radius:50%;border:4px solid rgba(255,255,255,0.25);margin:10px auto}
  #compassArrow{position:absolute;left:50%;top:50%;width:8px;height:46px;background:red;border-radius:4px;
    transform-origin:50% 85%;transform:translate(-50%,-50%) rotate(0deg)}
  .compass-label{position:absolute;font-size:.95rem;font-weight:800;opacity:.9}
  .n{left:50%;top:-18px;transform:translateX(-50%);color:red}
  .s{left:50%;bottom:-18px;transform:translateX(-50%)}
  .e{right:-18px;top:50%;transform:translateY(-50%)}
  .w{left:-18px;top:50%;transform:translateY(-50%)}
  #windText{text-align:center;font-size:1.05rem;margin-top:4px}
  /* Tide visuals */
  #tideChart{height:160px;display:flex;align-items:flex-end;gap:8px;justify-content:center;margin-top:8px}
  .bar{flex:1;min-width:38px;text-align:center;color:#fff;font-size:.9rem;font-weight:600;border-radius:6px 6px 0 0;display:flex;flex-direction:column;justify-content:flex-end}
  .bar span{background:rgba(0,0,0,0.45);width:100%;padding:2px;border-radius:0 0 6px 6px}
  #nextTide{margin-top:8px;text-align:center;font-weight:700;font-size:1.15rem;line-height:1.5}
  #nextTide .high{color:deepskyblue}
  #nextTide .low{color:#ff5a5a}
  #tideSource{text-align:center;margin-top:4px;font-size:0.9rem;color:#aaa}
  /* Map (static) */
  #mapWrap{padding:0 var(--pad);margin-bottom:var(--pad)}
  #map{height:220px;border-radius:8px;border:2px solid #333}
  /* Warnings at bottom */
  #warningsWrap{padding:0 var(--pad) var(--pad)}
  #warningsBox{min-height:120px;border:2px solid #333;border-radius:8px;padding:10px;position:relative;background:#141414}
  .warning{position:absolute;left:50%;transform:translateX(-50%);max-width:1100px;width:96%;
    opacity:0;transition:opacity .8s ease;padding:10px;border-radius:8px;font-weight:700;text-align:center}
  .warning.show{opacity:1}
  .red{background:#b30000;color:#fff}
  .orange{background:#ff7a00;color:#fff}
  .yellow{background:#ffcc00;color:#000}
  footer{text-align:center;padding:10px;background:#111;color:#ddd;font-size:1.05rem}
</style>
</head>
<body>
<header>
  <h1>Doolin CG Call-out Operations</h1>
  <button id="adminBtn" title="Admin">Admin</button>
</header>

<section id="sarIncident">
  <h2>Latest Coast Guard Incident</h2>
  <div id="incidentDetails"><p>No active incident entered.</p></div>
  <div id="incidentAdmin">
    <div>
      <input type="text" id="incidentTitle" placeholder="Incident Title">
      <input type="text" id="incidentDesc" placeholder="Incident Description / Location">
      <button id="saveIncidentBtn">Save Incident</button>
    </div>
  </div>
</section>

<div id="infoBar">
  <div><span id="locName">Doolin Port</span> ‚Äî <span id="latlon">Lat: 53.016, Lon: -9.400</span></div>
  <div>
    <label for="locationSelect">Location:</label>
    <select id="locationSelect"></select>
    <span id="clock">Current time: --:--:--</span>
  </div>
</div>

<main>
  <section class="panel">
    <h2>Weather <span id="weatherStatus" class="status-dot"></span></h2>
    <div id="weatherIcon">‚òÄÔ∏è</div>
    <div id="weatherData">Loading‚Ä¶</div>
    <div id="compass">
      <div class="compass-label n">N</div>
      <div class="compass-label s">S</div>
      <div class="compass-label e">E</div>
      <div class="compass-label w">W</div>
      <div id="compassArrow"></div>
    </div>
    <div id="windText"></div>
  </section>
  <section class="panel">
    <h2>Tide Forecast <span id="tideStatus" class="status-dot"></span></h2>
    <div id="tideChart">Loading‚Ä¶</div>
    <div id="nextTide"></div>
    <div id="tideSource"></div>
  </section>
</main>

<div id="mapWrap"><div id="map"></div></div>

<div id="warningsWrap">
  <div id="warningsBox"><em>Loading warnings‚Ä¶</em></div>
</div>

<footer>
  <div id="latestData">Latest data as of: --</div>
</footer>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const qs=id=>document.getElementById(id);

/* admin lock */
let adminEnabled=false;
qs('adminBtn').onclick=()=>{
  if(adminEnabled){qs('incidentAdmin').style.display='none';adminEnabled=false;return;}
  const pw=prompt('Enter admin password:');
  if(pw==='admin123'){adminEnabled=true;qs('incidentAdmin').style.display='block';}
};
qs('saveIncidentBtn').onclick=()=>{
  const t=qs('incidentTitle').value||'Untitled';
  const d=qs('incidentDesc').value||'';
  qs('incidentDetails').innerHTML=`<b>${t}</b><br>${d}`;
};

/* locations */
const LOCS={
 "DOOLIN": {name:"Doolin Port",lat:53.016,lon:-9.400},
 "LISCANNOR": {name:"Liscannor Bay",lat:52.933,lon:-9.400}
};
const sel=qs('locationSelect');
for(const k in LOCS){const o=document.createElement('option');o.value=k;o.textContent=LOCS[k].name;sel.appendChild(o);}
let CUR=LOCS['DOOLIN'];
sel.onchange=()=>{CUR=LOCS[sel.value];updateAll();};

/* map (static) */
let map=L.map('map',{zoomControl:false}).setView([CUR.lat,CUR.lon],11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker=L.marker([CUR.lat,CUR.lon]).addTo(map);
map.dragging.disable();map.scrollWheelZoom.disable();map.doubleClickZoom.disable();

/* clock */
setInterval(()=>{qs('clock').textContent="Current time: "+new Date().toLocaleTimeString("en-IE",{hour12:false});},1000);

/* weather */
function compassDir(d){const dirs=["N","NE","E","SE","S","SW","W","NW"];return dirs[Math.round(d/45)%8];}
function iconForCode(c){if(c===0)return"‚òÄÔ∏è";if([1,2,3].includes(c))return"üå§";if([45,48].includes(c))return"üå´";if([51,53,55,61,63,65,80,81,82].includes(c))return"üåß";if([71,73,75].includes(c))return"‚ùÑÔ∏è";if([95,96,99].includes(c))return"‚õà";return"‚ùì";}
async function loadWeather(){
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${CUR.lat}&longitude=${CUR.lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,weathercode&timezone=Europe%2FDublin`);
    const j=await r.json();
    const c=j.current;
    qs('weatherIcon').textContent=iconForCode(c.weathercode);
    qs('weatherData').innerHTML=`<b>${c.temperature_2m}¬∞C</b><br>Wind: ${c.wind_speed_10m} km/h`;
    qs('compassArrow').style.transform=`translate(-50%,-50%) rotate(${c.wind_direction_10m}deg)`;
    qs('windText').textContent=`${c.wind_direction_10m}¬∞ ${compassDir(c.wind_direction_10m)}`;
    qs('weatherStatus').style.background='green';
  }catch{qs('weatherData').textContent="Weather error";qs('weatherStatus').style.background='red';}
}

/* tide stub (for demo, replace with your fixed tide code) */
async function loadTide(){qs('tideChart').textContent="Tide feed placeholder";qs('tideStatus').style.background='yellow';}

/* warnings: weather + marine + small craft */
let warnTimer=null,warnIndex=0;
function showWarning(count){for(let i=0;i<count;i++){const el=qs('warn'+i);if(el)el.classList.remove('show');}const el=qs('warn'+warnIndex);if(el)el.classList.add('show');}
async function loadWarnings(){
  clearInterval(warnTimer);
  const box=qs('warningsBox');box.innerHTML="<em>Loading warnings‚Ä¶</em>";
  try{
    const [wRes,mRes]=await Promise.all([
      fetch("https://www.met.ie/Open_Data/json/warning.json"),
      fetch("https://www.met.ie/Open_Data/json/marine.json")
    ]);
    const weather=await wRes.json(), marine=await mRes.json();
    const counties=["Clare","Galway","Limerick","Kerry","Mayo"];
    const all=[];
    (Array.isArray(weather)?weather:weather.data||[]).forEach(w=>{
      const colour=(w.colour||"").toLowerCase();
      if(!["red","orange","yellow"].includes(colour))return;
      if((w.regions||[]).some(r=>counties.includes(r))){
        all.push({colour,headline:w.headline,desc:w.description});
      }
    });
    (Array.isArray(marine)?marine:marine.data||[]).forEach(m=>{
      const title=m.title||m.headline||"Marine Warning";
      if(/small craft/i.test(title)) all.push({colour:"orange",headline:"Small Craft Warning",desc:title});
      else all.push({colour:"orange",headline:"Marine Warning",desc:title});
    });
    if(!all.length){box.innerHTML="<em>No current warnings.</em>";return;}
    box.innerHTML=all.map((w,i)=>`<div class="warning ${w.colour}" id="warn${i}"><b>${w.headline}</b> ‚Äî ${w.desc}</div>`).join("");
    warnIndex=0;showWarning(all.length);
    warnTimer=setInterval(()=>{warnIndex=(warnIndex+1)%all.length;showWarning(all.length);},10000);
  }catch{box.innerHTML="‚ö†Ô∏è Error loading warnings";}
}

/* update loop */
function updateAll(){
  qs('locName').textContent=CUR.name;
  qs('latlon').textContent=`Lat: ${CUR.lat.toFixed(3)}, Lon: ${CUR.lon.toFixed(3)}`;
  map.setView([CUR.lat,CUR.lon],11);marker.setLatLng([CUR.lat,CUR.lon]);
  qs('latestData').textContent="Latest data as of: "+new Date().toLocaleTimeString("en-IE",{hour12:false});
  loadWeather();loadTide();loadWarnings();
}
updateAll();setInterval(updateAll,60000);
</script>
</body>
</html>
