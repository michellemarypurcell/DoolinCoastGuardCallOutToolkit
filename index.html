<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doolin CG Call-out Operations</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{--pad:16px;--panel:#1c1c1c;--ink:#fff;--sub:#ddd}
  *{box-sizing:border-box}
  body{margin:0;background:#0b0b0b;color:var(--ink);font-family:Segoe UI,Arial,sans-serif;overflow:hidden}
  header{padding:var(--pad);background:#111;border-bottom:3px solid #2aa3ff;display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:2.0rem}
  #adminBtn{background:#2aa3ff;border:none;color:#fff;font-weight:700;padding:8px 12px;border-radius:8px;cursor:pointer}
  #sarIncident{background:rgba(220,0,0,0.85);padding:12px;margin:10px;border-radius:10px;text-align:center}
  #sarIncident h2{margin:0 0 6px;font-size:1.2rem}
  #incidentDetails{font-size:1.05rem;font-weight:600}
  #incidentAdmin{display:none;margin-top:10px;text-align:center}
  #incidentAdmin input{padding:6px;margin:4px;border-radius:6px;border:1px solid #333;background:#0f0f0f;color:#fff}
  #incidentAdmin button{padding:6px 12px;border:none;border-radius:6px;background:#2aa3ff;color:#fff;font-weight:600;cursor:pointer}
  #infoBar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#141414;
    padding:10px;border-top:1px solid #222;border-bottom:1px solid #222}
  #locName{font-weight:800}
  #latlon{color:var(--sub)}
  #locationSelect{background:#0f0f0f;color:#fff;border:1px solid #333;padding:6px;border-radius:8px}
  main{display:flex;gap:20px;padding:var(--pad);height:48vh;min-height:360px}
  .panel{flex:1 1 50%;background:var(--panel);border-radius:12px;padding:16px;display:flex;flex-direction:column;justify-content:center}
  .panel h2{text-align:center;margin:0 0 10px;font-size:1.3rem}
  .status-dot{display:inline-block;width:12px;height:12px;border-radius:50%;margin-left:6px;background:#666;vertical-align:middle}
  /* Weather visuals */
  #weatherIcon{font-size:3.8rem;text-align:center;margin-bottom:8px}
  #weatherData{font-size:1.2rem;text-align:center;line-height:1.5}
  #compass{position:relative;width:110px;height:110px;border-radius:50%;border:4px solid rgba(255,255,255,0.25);margin:10px auto}
  #compassArrow{position:absolute;left:50%;top:50%;width:8px;height:46px;background:red;border-radius:4px;
    transform-origin:50% 85%;transform:translate(-50%,-50%) rotate(0deg)}
  .compass-label{position:absolute;font-size:.95rem;font-weight:800;opacity:.9}
  .n{left:50%;top:-18px;transform:translateX(-50%);color:red}
  .s{left:50%;bottom:-18px;transform:translateX(-50%)}
  .e{right:-18px;top:50%;transform:translateY(-50%)}
  .w{left:-18px;top:50%;transform:translateY(-50%)}
  #windText{text-align:center;font-size:1.05rem;margin-top:4px}
  /* Tide visuals */
  #tideChart{height:170px;display:flex;align-items:flex-end;gap:8px;justify-content:center;margin-top:8px}
  .bar{flex:1;min-width:38px;text-align:center;color:#fff;font-size:.9rem;font-weight:600;border-radius:6px 6px 0 0;display:flex;flex-direction:column;justify-content:flex-end}
  .bar span{background:rgba(0,0,0,0.45);width:100%;padding:2px;border-radius:0 0 6px 6px}
  #nextTide{margin-top:8px;text-align:center;font-weight:700;font-size:1.15rem;line-height:1.5}
  #nextTide .high{color:deepskyblue}
  #nextTide .low{color:#ff5a5a}
  #tideSource{text-align:center;margin-top:4px;font-size:0.9rem;color:#aaa}
  /* Map (static) */
  #mapWrap{padding:0 var(--pad);margin-bottom:var(--pad)}
  #map{height:220px;border-radius:8px;border:2px solid #333}
  /* Warnings at bottom */
  #warningsWrap{padding:0 var(--pad) var(--pad)}
  #warningsBox{min-height:120px;border:2px solid #333;border-radius:8px;padding:10px;position:relative;background:#141414}
  .warning{position:absolute;left:50%;transform:translateX(-50%);max-width:1100px;width:96%;
    opacity:0;transition:opacity .8s ease;padding:10px;border-radius:8px;font-weight:700;text-align:center}
  .warning.show{opacity:1}
  .red{background:#b30000;color:#fff}
  .orange{background:#ff7a00;color:#fff}
  .yellow{background:#ffcc00;color:#000}
  footer{text-align:center;padding:10px;background:#111;color:#ddd;font-size:1.05rem}
  #debug{display:none;position:fixed;left:0;right:0;bottom:0;background:#000;color:#0f0;padding:8px;max-height:160px;overflow:auto;font-size:.85rem;border-top:1px solid #333}
  @media(max-width:900px){
    main{flex-direction:column;height:auto}
    body{overflow:auto}
  }
</style>
</head>
<body>
<header>
  <h1>Doolin CG Call-out Operations</h1>
  <button id="adminBtn" title="Admin">Admin</button>
</header>

<section id="sarIncident">
  <h2>Latest Coast Guard Incident</h2>
  <div id="incidentDetails"><p>No active incident entered.</p></div>
  <div id="incidentAdmin">
    <div>
      <input type="text" id="incidentTitle" placeholder="Incident Title">
      <input type="text" id="incidentDesc" placeholder="Incident Description / Location">
      <button id="saveIncidentBtn">Save Incident</button>
    </div>
  </div>
</section>

<div id="infoBar">
  <div><span id="locName">Doolin Port</span> ‚Äî <span id="latlon">Lat: 53.016, Lon: -9.400</span></div>
  <div>
    <label for="locationSelect">Location:</label>
    <select id="locationSelect"></select>
    <span id="clock">Current time: --:--:--</span>
  </div>
</div>

<main>
  <section class="panel">
    <h2>Weather <span id="weatherStatus" class="status-dot"></span></h2>
    <div id="weatherIcon">‚òÄÔ∏è</div>
    <div id="weatherData">Loading‚Ä¶</div>
    <div id="compass">
      <div class="compass-label n">N</div>
      <div class="compass-label s">S</div>
      <div class="compass-label e">E</div>
      <div class="compass-label w">W</div>
      <div id="compassArrow"></div>
    </div>
    <div id="windText"></div>
  </section>
  <section class="panel">
    <h2>Tide Forecast <span id="tideStatus" class="status-dot"></span></h2>
    <div id="tideChart">Loading‚Ä¶</div>
    <div id="nextTide"></div>
    <div id="tideSource"></div>
  </section>
</main>

<div id="mapWrap"><div id="map"></div></div>

<div id="warningsWrap">
  <div id="warningsBox"><em>Loading warnings‚Ä¶</em></div>
</div>

<footer>
  <div id="latestData">Latest data as of: --</div>
</footer>

<pre id="debug"></pre>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ---------- helpers ---------- */
const qs=id=>document.getElementById(id);
const log=(m)=>{const d=qs('debug');d.textContent+=m+"\\n";d.scrollTop=d.scrollHeight;}
document.addEventListener('keydown',e=>{if(e.key==='d') qs('debug').style.display = qs('debug').style.display==='block'?'none':'block';});

/* ---------- admin lock ---------- */
let adminEnabled=false;
qs('adminBtn').onclick=()=>{
  if(adminEnabled){qs('incidentAdmin').style.display='none';adminEnabled=false;return;}
  const pw=prompt('Enter admin password:');
  if(pw==='admin123'){adminEnabled=true;qs('incidentAdmin').style.display='block';}
  else alert('Wrong password');
};
qs('saveIncidentBtn').onclick=()=>{
  const t=qs('incidentTitle').value||'Untitled';
  const d=qs('incidentDesc').value||'';
  qs('incidentDetails').innerHTML=`<b>${t}</b><br>${d}`;
  try{localStorage.setItem('incident',JSON.stringify({t,d}));}catch(_){}
};
// restore incident
try{
  const inc=JSON.parse(localStorage.getItem('incident')||'null');
  if(inc){qs('incidentDetails').innerHTML=`<b>${inc.t}</b><br>${inc.d}`;}
}catch(_){}

/* ---------- locations & stations ---------- */
const LOCS={
 "DOOLIN":       {name:"Doolin Port",    lat:53.016, lon:-9.400, station:"Inishmore"},
 "BALLYVAUGHAN": {name:"Ballyvaughan",   lat:53.120, lon:-9.150, station:"Galway_Port"},
 "KINVARA":      {name:"Kinvara",        lat:53.140, lon:-8.930, station:"Galway_Port"},
 "GALWAY":       {name:"Galway",         lat:53.270, lon:-9.050, station:"Galway_Port"},
 "LISCANNOR":    {name:"Liscannor Bay",  lat:52.933, lon:-9.400, station:"Inishmore"},
 "LAHINCH":      {name:"Lahinch",        lat:52.933, lon:-9.350, station:"Inishmore"},
 "FANORE":       {name:"Fanore",         lat:53.140, lon:-9.280, station:"Inishmore"},
 "INIS_MOR":     {name:"Inis M√≥r",       lat:53.110, lon:-9.650, station:"Inishmore"},
 "INIS_MEAIN":   {name:"Inis Me√°in",     lat:53.080, lon:-9.570, station:"Inishmaan"},
 "INIS_OIRR":    {name:"Inis O√≠rr",      lat:53.060, lon:-9.510, station:"Inisheer"},
 "KILKEE":       {name:"Kilkee",         lat:52.678, lon:-9.644, station:"Kilrush"},
 "WHITESTRAND":  {name:"Whitestrand",    lat:52.850, lon:-9.420, station:"Kilrush"},
 "QUILTY":       {name:"Quilty",         lat:52.820, lon:-9.450, station:"Kilrush"},
 "KILRUSH":      {name:"Kilrush",        lat:52.640, lon:-9.480, station:"Kilrush"}
};
const sel=qs('locationSelect');
for(const k in LOCS){const o=document.createElement('option');o.value=k;o.textContent=LOCS[k].name;sel.appendChild(o);}
let CUR=LOCS['DOOLIN'];
sel.value='DOOLIN';
sel.onchange=()=>{CUR=LOCS[sel.value];updateAll();};

/* ---------- map (static) ---------- */
let map, marker;
function setHeaderAndMap(){
  qs('locName').textContent=CUR.name;
  qs('latlon').textContent=`Lat: ${CUR.lat.toFixed(3)}, Lon: ${CUR.lon.toFixed(3)}`;
  if(!map){
    map=L.map('map',{zoomControl:false,attributionControl:true}).setView([CUR.lat,CUR.lon],11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM'}).addTo(map);
    marker=L.marker([CUR.lat,CUR.lon]).addTo(map);
    // disable interactions for TV (static visual)
    map.dragging.disable(); map.scrollWheelZoom.disable(); map.doubleClickZoom.disable();
    map.boxZoom.disable(); map.keyboard.disable(); if(map.tap) map.tap.disable();
  } else {
    map.setView([CUR.lat,CUR.lon],11);
    marker.setLatLng([CUR.lat,CUR.lon]);
  }
}

/* ---------- clock ---------- */
setInterval(()=>{qs('clock').textContent="Current time: "+new Date().toLocaleTimeString("en-IE",{hour12:false});},1000);

/* ---------- weather (Open-Meteo) ---------- */
function compassDir(deg){const d=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return d[Math.round(deg/22.5)%16];}
function iconForCode(c){if(c===0)return"‚òÄÔ∏è";if([1,2,3].includes(c))return"üå§";if([45,48].includes(c))return"üå´";if([51,53,55,56,57,61,63,65,66,67].includes(c))return"üå¶";if([71,73,75,77].includes(c))return"‚ùÑÔ∏è";if([80,81,82].includes(c))return"üåß";if([95,96,99].includes(c))return"‚õà";return"‚ùì";}
async function loadWeather(){
  const u=`https://api.open-meteo.com/v1/forecast?latitude=${CUR.lat}&longitude=${CUR.lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,weathercode&timezone=Europe%2FDublin&ts=${Date.now()}`;
  try{
    const r=await fetch(u,{cache:'no-store'});
    const j=await r.json();
    if(!j.current){qs('weatherData').textContent='No weather';qs('weatherStatus').style.background='red';return;}
    const c=j.current;
    qs('weatherIcon').textContent=iconForCode(c.weathercode);
    qs('weatherData').innerHTML=`<b>${c.temperature_2m}¬∞C</b><br>Wind: ${c.wind_speed_10m} km/h`;
    qs('compassArrow').style.transform=`translate(-50%,-50%) rotate(${c.wind_direction_10m}deg)`;
    qs('windText').textContent=`${c.wind_direction_10m}¬∞ ${compassDir(c.wind_direction_10m)}`;
    qs('weatherStatus').style.background='green';
  }catch(e){
    qs('weatherData').textContent='Weather error';
    qs('weatherStatus').style.background='red';
  }
}

/* ---------- tides (ERDDAP CSV via proxies) ---------- */
function tideColor(h){if(h<0.5)return"red";if(h<1.5)return"orange";if(h<=3.0)return"limegreen";return"deepskyblue";}
function isoNoMs(d){return d.toISOString().split('.')[0]+"Z";}
function parseERDDAPCSV(text){
  // Guard against HTML error pages
  if(/<html|<!DOCTYPE/i.test(text)) throw new Error('HTML from ERDDAP');
  const lines=text.trim().split(/\r?\n/);
  // Find real header row (ERDDAP may prepend metadata)
  let headerIdx=lines.findIndex(l=>/^stationID\s*,\s*time\s*,\s*Prediction/i.test(l));
  if(headerIdx===-1) headerIdx=lines.findIndex(l=>/stationID/i.test(l)&&/time/i.test(l)&&/Pred/i.test(l));
  if(headerIdx===-1) return [];
  const header=lines[headerIdx].split(',');
  const idxStation=header.findIndex(h=>/stationID/i.test(h));
  const idxTime=header.findIndex(h=>/^time$/i.test(h));
  let idxPred=header.findIndex(h=>/prediction/i.test(h));
  if(idxPred<0) idxPred=header.indexOf('Prediction');
  const rows=[];
  for(let i=headerIdx+1;i<lines.length;i++){
    const l=lines[i].trim(); if(!l||/^,+$/.test(l)) continue;
    const cols=l.split(',');
    const st=cols[idxStation]; const t=cols[idxTime]; const p=parseFloat(cols[idxPred]);
    if(st && t && Number.isFinite(p)) rows.push([st,t,p]);
  }
  return rows;
}
async function fetchTideCSV(url){
  const tries=[
    "https://thingproxy.freeboard.io/fetch/"+url,
    "https://api.allorigins.win/raw?url="+encodeURIComponent(url)
  ];
  let lastErr=null;
  for(const u of tries){
    try{
      const r=await fetch(u,{cache:'no-store'});
      const txt=await r.text();
      const rows=parseERDDAPCSV(txt);
      if(rows.length) return rows;
      // if CSV but 0 rows, return empty (caller handles yellow state)
      if(!/<html|<!DOCTYPE/i.test(txt)) return [];
      lastErr=new Error('HTML received from ERDDAP');
    }catch(e){lastErr=e;}
  }
  throw lastErr||new Error('All proxies failed');
}
async function loadTide(){
  const tideDot=qs('tideStatus');
  if(!CUR.station){qs('tideChart').textContent='‚ö†Ô∏è No tide station for this location.'; tideDot.style.background='red'; qs('nextTide').textContent=''; qs('tideSource').textContent=''; return;}
  const start=new Date();                // now
  const end=new Date(start.getTime()+12*3600*1000); // next 12h
  const url=`https://erddap.marine.ie/erddap/tabledap/IMI_TidePrediction.csv?stationID,time,Prediction&stationID=${encodeURIComponent(CUR.station)}&time>=${isoNoMs(start)}&time<=${isoNoMs(end)}&orderBy(%22time%22)&_ts=${Date.now()}`;
  qs('tideChart').textContent='Loading‚Ä¶';
  log('Tide URL: '+url);
  try{
    const rows=await fetchTideCSV(url);
    if(!rows.length){qs('tideChart').textContent=`‚ö†Ô∏è No tide predictions for ${CUR.station}`; tideDot.style.background='yellow'; qs('nextTide').textContent=''; qs('tideSource').textContent=''; return;}
    const now=new Date();
    const future=rows.filter(r=>new Date(r[1])>=now).slice(0,6);
    if(!future.length){qs('tideChart').textContent='‚ö†Ô∏è No upcoming tide predictions.'; tideDot.style.background='yellow'; qs('nextTide').textContent=''; qs('tideSource').textContent=''; return;}
    const heights=future.map(r=>r[2]);
    const maxH=Math.max(...heights), minH=Math.min(...heights);
    const highRow=future[heights.indexOf(maxH)], lowRow=future[heights.indexOf(minH)];
    const bars=future.map((r,i)=>{
      const timeStr=new Date(r[1]).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});
      const h=r[2];
      // trend shading
      let trend='', bg=tideColor(h);
      if(i<future.length-1){
        const nextH=future[i+1][2];
        if(nextH>h){trend='‚¨ÜÔ∏è'; bg=`linear-gradient(to top, deepskyblue, ${tideColor(h)})`;}
        else if(nextH<h){trend='‚¨áÔ∏è'; bg=`linear-gradient(to top, #555, ${tideColor(h)})`;}
      }
      const tag = (h===maxH) ? 'üåä' : (h===minH ? '‚¨áÔ∏è' : '');
      return `<div class="bar" style="height:${Math.max(10,h*42)}px;background:${bg}">
                <div style="font-size:1.2rem">${tag}</div>
                <span>${timeStr}<br>${h.toFixed(2)}m ${trend}</span>
              </div>`;
    }).join('');
    qs('tideChart').innerHTML=bars;
    const highTime=new Date(highRow[1]).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});
    const lowTime=new Date(lowRow[1]).toLocaleTimeString('en-IE',{hour:'2-digit',minute:'2-digit',hour12:false});
    qs('nextTide').innerHTML=
      `<span class="high"><b>Next High Tide:</b> ${highTime} ‚Äî ${maxH.toFixed(2)} m üåä</span><br>`+
      `<span class="low"><b>Next Low Tide:</b> ${lowTime} ‚Äî ${minH.toFixed(2)} m ‚¨áÔ∏è</span>`;
    qs('tideSource').textContent=`Source: Marine Institute ‚Äî ${CUR.station}`;
    tideDot.style.background='green';
  }catch(e){
    qs('tideChart').textContent='‚ö†Ô∏è Tide fetch failed';
    tideDot.style.background='red';
    log('Tide error: '+(e.message||e));
  }
}

/* ---------- warnings (weather + marine + small craft) ---------- */
let warnTimer=null, warnIndex=0;
function showWarning(count){
  for(let i=0;i<count;i++){const el=qs('warn'+i); if(el) el.classList.remove('show');}
  const el=qs('warn'+warnIndex); if(el) el.classList.add('show');
}
async function loadWarnings(){
  clearInterval(warnTimer);
  const box=qs('warningsBox');
  box.innerHTML='<em>Loading warnings‚Ä¶</em>';
  // feeds
  const weatherURL='https://www.met.ie/Open_Data/json/warning.json?ts='+Date.now();
  const marineURL='https://www.met.ie/Open_Data/json/marine.json?ts='+Date.now();
  const proxies=[u=>u, u=>'https://api.allorigins.win/raw?url='+encodeURIComponent(u)];
  async function getJSON(u){
    let last=null;
    for(const wrap of proxies){
      try{const r=await fetch(wrap(u),{cache:'no-store'});const t=await r.text();const j=JSON.parse(t);return j;}catch(e){last=e;}
    }
    throw last||new Error('Fetch failed');
  }
  try{
    const [weather,marine]=await Promise.all([getJSON(weatherURL), getJSON(marineURL)]);
    const counties=["Clare","Galway","Limerick","Kerry","Mayo"];
    const items=[];
    // Weather warnings (filter counties, red/orange/yellow)
    (Array.isArray(weather)?weather:(weather?.data||[])).forEach(w=>{
      const colour=(w.colour||w.Colour||'').toLowerCase();
      if(!['red','orange','yellow'].includes(colour)) return;
      const regs=(w.regions||w.Regions||[]);
      if(!regs.some(r=>counties.includes(r))) return;
      const headline=w.headline||w.Headline||'Weather Warning';
      const desc=(w.description||w.Description||'').replace(/\n+/g,' ');
      const when = w.valid_from && w.valid_to ? ` (valid ${w.valid_from} ‚Üí ${w.valid_to})` : '';
      items.push({colour, text:`${headline} ‚Äî ${regs.join(', ')}${when}. ${desc}`});
    });
    // Marine + Small Craft (whole coast)
    (Array.isArray(marine)?marine:(marine?.data||[])).forEach(m=>{
      const title=(m.title||m.headline||'Marine Warning').replace(/\n+/g,' ');
      const colourGuess = /red/i.test(title) ? 'red' : 'orange';
      items.push({
        colour: /small craft/i.test(title) ? 'orange' : colourGuess,
        text: title
      });
    });
    if(!items.length){ box.innerHTML='<em>No current warnings.</em>'; return; }
    box.innerHTML = items.map((w,i)=>`<div class="warning ${w.colour}" id="warn${i}"><b>${w.colour.toUpperCase()} WARNING:</b> ${w.text}</div>`).join('');
    warnIndex=0; showWarning(items.length);
    warnTimer=setInterval(()=>{warnIndex=(warnIndex+1)%items.length;showWarning(items.length);},10000);
  }catch(e){
    box.innerHTML='‚ö†Ô∏è Error loading warnings.';
  }
}

/* ---------- refresh ---------- */
function updateAll(){
  setHeaderAndMap();
  const now=new Date();
  qs('latestData').textContent='Latest data as of: '+now.toLocaleTimeString('en-IE',{hour12:false});
  loadWeather();
  loadTide();
  loadWarnings();
}
updateAll();
setInterval(updateAll,60000);
</script>
</body>
</html>
