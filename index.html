<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Doolin Coast Guard Call-out OPs</title>
<style>
  body{margin:0;background:#0b0b0b;color:#fff;font-family:Segoe UI,Arial,sans-serif}
  header{padding:12px;background:#111;text-align:center;border-bottom:3px solid #2aa3ff}
  h1{margin:0;font-size:1.9rem}
  #sarIncident{background:rgba(220,0,0,0.85);padding:14px;margin:10px;border-radius:10px;text-align:center}
  #sarIncident h2{margin:0 0 8px}
  #incidentDetails{font-size:1.1rem;font-weight:600}
  #infoBar{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;background:#141414;
    padding:10px;border-top:1px solid #222;border-bottom:1px solid #222}
  #locName{font-weight:800}
  #latlon,#dataFrom,#clock{color:#ddd}
  #locationSelect{background:#0f0f0f;color:#fff;border:1px solid #333;padding:6px;border-radius:8px}
  main{display:flex;gap:16px;padding:12px;flex-wrap:wrap}
  .panel{flex:1 1 420px;background:#1c1c1c;border-radius:12px;padding:14px;min-height:160px}
  .panel h2{text-align:center;margin:0 0 10px}
  #weatherIcon{font-size:3rem;margin-bottom:6px;text-align:center}
  /* Compass */
  #compass{position:relative;width:100px;height:100px;border-radius:50%;border:3px solid rgba(255,255,255,0.25)}
  #compassArrow{position:absolute;left:50%;top:50%;width:6px;height:40px;background:red;border-radius:3px;
    transform-origin:50% 85%;transform:translate(-50%,-50%) rotate(0deg)}
  .compass-label{position:absolute;font-size:0.9rem;font-weight:800;opacity:.9}
  .n{left:50%;top:-18px;transform:translateX(-50%);color:red}
  .s{left:50%;bottom:-18px;transform:translateX(-50%)}
  .e{right:-18px;top:50%;transform:translateY(-50%)}
  .w{left:-18px;top:50%;transform:translateY(-50%)}
  /* Tide list */
  #tideData h3{margin:0 0 8px;font-size:1rem;color:#aaa;text-align:center}
  #tideData ul{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:12px;justify-content:center}
  #tideData li{font-size:1.1rem;font-weight:600;padding:2px 6px;border-radius:6px}
  .flash{animation:flash 1s infinite}
  @keyframes flash {0%{background:yellow;color:black}50%{background:none}100%{background:yellow;color:black}}
  #nextTide{margin-top:10px;text-align:center;font-weight:700;color:#fff}
  footer{text-align:center;padding:12px;background:#111;color:#ddd}
  #debug{position:fixed;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);color:#0f0;padding:6px;font:12px/1.3 Consolas,monospace;max-height:140px;overflow:auto}
</style>
</head>
<body>
<header><h1>Doolin Coast Guard Call-out OPs</h1></header>

<section id="sarIncident">
  <h2>Latest Coast Guard Incident</h2>
  <div id="incidentDetails"><p>No active incident entered.</p></div>
</section>

<div id="infoBar">
  <div>
    <span id="locName">Doolin Port</span> ‚Äî
    <span id="latlon">Lat: 53.016, Lon: -9.400</span> ‚Äî
    <span id="dataFrom">Data from: --:--:--</span>
  </div>
  <div>
    <label for="locationSelect">Location:</label>
    <select id="locationSelect"></select>
    <span id="clock">Current time: --:--:--</span>
  </div>
</div>

<main>
  <section class="panel">
    <h2>Weather</h2>
    <div id="weatherIcon">‚òÄÔ∏è</div>
    <div id="weatherData">Loading‚Ä¶</div>
    <div style="margin-top:10px;display:flex;align-items:center;gap:20px;flex-wrap:wrap">
      <div id="compass">
        <div class="compass-label n">N</div>
        <div class="compass-label s">S</div>
        <div class="compass-label e">E</div>
        <div class="compass-label w">W</div>
        <div id="compassArrow"></div>
      </div>
      <div id="windText"></div>
    </div>
  </section>
  <section class="panel">
    <h2>Tide Forecast</h2>
    <div id="tideData">Loading‚Ä¶</div>
    <div id="nextTide"></div>
  </section>
</main>

<footer>
  <div id="latestData">Latest data as of: --</div>
</footer>

<pre id="debug"></pre>

<script>
function log(m){const d=document.getElementById('debug');d.textContent+=m+"\\n";d.scrollTop=d.scrollHeight;}
function qs(id){return document.getElementById(id);}

/* Locations */
const LOCS={
 "DOOLIN":{name:"Doolin Port",lat:53.016,lon:-9.4,station:"Inishmore"},
 "GALWAY":{name:"Galway",lat:53.270,lon:-9.050,station:"Galway_Port"},
 "KILKEE":{name:"Kilkee",lat:52.678,lon:-9.644,station:"Kilrush"}
};
const sel=qs("locationSelect");
for(const k in LOCS){const o=document.createElement("option");o.value=k;o.textContent=LOCS[k].name;if(k==="DOOLIN")o.selected=true;sel.appendChild(o);}
let CUR=LOCS["DOOLIN"];
sel.onchange=()=>{CUR=LOCS[sel.value];updateAll();};
function setCurrent(loc){CUR=LOCS[loc];qs("locName").textContent=CUR.name;qs("latlon").textContent="Lat: "+CUR.lat.toFixed(3)+", Lon: "+CUR.lon.toFixed(3);}

/* Clock */
function startClock(){setInterval(()=>{qs("clock").textContent="Current time: "+new Date().toLocaleTimeString("en-IE",{hour12:false});},1000);}
startClock();

/* Weather */
function compassDir(deg){const dirs=["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"];return dirs[Math.round(deg/22.5)%16];}
function iconForCode(c){if(c===0)return"‚òÄÔ∏è";if([1,2,3].includes(c))return"üå§";if([45,48].includes(c))return"üå´";if([51,53,55,56,57,61,63,65,66,67].includes(c))return"üå¶";if([71,73,75,77].includes(c))return"‚ùÑÔ∏è";if([80,81,82].includes(c))return"üåß";if([95,96,99].includes(c))return"‚õà";return"‚ùì";}
function loadWeather(){
  const u=`https://api.open-meteo.com/v1/forecast?latitude=${CUR.lat}&longitude=${CUR.lon}&current=temperature_2m,wind_speed_10m,wind_direction_10m,weathercode&timezone=Europe%2FDublin`;
  fetch(u).then(r=>r.json()).then(j=>{
    if(!j.current){qs("weatherData").textContent="No weather";return;}
    const c=j.current;
    qs("weatherIcon").textContent=iconForCode(c.weathercode);
    qs("weatherData").innerHTML=`Temp: ${c.temperature_2m}¬∞C<br>Wind: ${c.wind_speed_10m} km/h`;
    qs("compassArrow").style.transform=`translate(-50%,-50%) rotate(${c.wind_direction_10m}deg)`;
    qs("windText").textContent=`${c.wind_direction_10m}¬∞ ${compassDir(c.wind_direction_10m)}`;
  }).catch(e=>{qs("weatherData").textContent="Weather error";log("Weather error "+e);});
}

/* Tides */
function isoNoMs(d){return d.toISOString().split('.')[0]+"Z";}
function tideColor(h){
  if(h<0.5) return "red";
  if(h<1.5) return "orange";
  if(h<=3.0) return "limegreen";
  return "deepskyblue";
}
function loadTide(){
  const start=new Date(Date.now()-3600*1000); // 1h back
  const end=new Date(Date.now()+12*3600*1000); // 12h forward
  const u=`https://erddap.marine.ie/erddap/tabledap/TidePrediction.json?station_id,time,sea_surface_height&station_id=${encodeURIComponent(CUR.station)}&time>=${isoNoMs(start)}&time<=${isoNoMs(end)}`;
  fetch(u).then(r=>r.json()).then(j=>{
    const rows=j.table?.rows||[];
    if(!rows.length){
      qs("tideData").innerHTML=`‚ö†Ô∏è No tide data for <b>${CUR.station}</b>`;
      return;
    }

    const limited=rows.slice(0,6);
    const heights=limited.map(r=>parseFloat(r[2]));
    const minH=Math.min(...heights);
    const maxH=Math.max(...heights);

    const now=new Date();
    let nextIdx=-1;
    let nextLabel="";
    limited.forEach((r,i)=>{
      const t=new Date(r[1]);
      const h=parseFloat(r[2]);
      if(t>now && (h===minH||h===maxH) && nextIdx===-1){
        nextIdx=i;
        nextLabel=h===minH?"Low Tide":"High Tide";
      }
    });

    const list=limited.map((r,i)=>{
      const t=new Date(r[1]).toLocaleTimeString("en-IE",{hour:'2-digit',minute:'2-digit',hour12:false});
      const h=parseFloat(r[2]);
      let style=`color:${tideColor(h)};`;
      let extra="";
      if(h===minH) extra=" <strong>(Low)</strong>";
      if(h===maxH) extra=" <strong>(High)</strong>";
      let cls=(i===nextIdx)?"flash":"";
      return `<li class="${cls}" style="${style}">${t} ‚Äî <b>${h.toFixed(2)} m</b>${extra}</li>`;
    }).join("");

    qs("tideData").innerHTML=`<h3>Next 6 hours</h3><ul>${list}</ul>`;

    if(nextIdx>-1){
      const t=new Date(limited[nextIdx][1]);
      const diff=(t-now)/1000;
      const h=Math.floor(diff/3600);
      const m=Math.floor((diff%3600)/60);
      qs("nextTide").textContent=`Next ${nextLabel} in ${h}h ${m}m`;
    } else {
      qs("nextTide").textContent="";
    }
  }).catch(e=>{
    qs("tideData").textContent="Tide error";
    log("Tide err "+e);
  });
}

/* Refresh */
function updateAll(){
  setCurrent(sel.value);
  const now=new Date();
  qs("dataFrom").textContent="Data from: "+now.toLocaleTimeString("en-IE",{hour12:false});
  qs("latestData").textContent="Latest data as of: "+now.toLocaleTimeString("en-IE",{hour12:false});
  loadWeather();loadTide();
}
updateAll();setInterval(updateAll,60000);
</script>
</body>
</html>
